# ✅ Исправление холодного запуска приложения

## Проблема

При холодном запуске приложения логин проходит успешно, но главный экран не загружает данные. Отображается пустая болванка без счётчиков заказов и другого контента.

## Причины

1. **Десинхронизация загрузки профиля и роли** — информация о пользователе загружалась с задержкой
2. **Рендер контента раньше данных** — `UniversalHome` показывался до загрузки счётчиков
3. **Неправильные параметры кэширования** — React Query не кэшировал профиль между переходами

## Решение

### 1. **app/\_layout.js** — Предварительная загрузка профиля

```javascript
// После SIGNED_IN событий:
// - Явно загружаем профиль из БД
// - Кэшируем в React Query с ключом ['profile', userId]
// - Это гарантирует, что UniversalHome получит данные мгновенно
```

### 2. **components/universalhome.jsx** — Синхронизация загрузки

```javascript
// Изменения:
// - Добавлена переменная readyForCounts = !!uid && !profileLoading && !!resolvedRole
// - Счётчики загружаются ТОЛЬКО когда все условия выполнены
// - Добавлена защита от рендера до загрузки профиля
// - Улучшено кэширование профиля (staleTime: 60s вместо 0)
```

### 3. **app/orders/index.jsx** — Корректный шаг рендера

```javascript
// Изменения:
// - UniversalHome рендерится только если role загрузилась
// - Вместо пустого контента показывается сплэш экран
// - role имеет refetchOnMount: 'stale' для свежести при возврате на экран
```

## Что изменилось при запуске

### Было (проблема):

1. Пользователь логинится
2. `orders/index.jsx` рендерится с `role={undefined}`
3. `UniversalHome` рендерится без данных профиля
4. Счётчики пытаются загружаться параллельно с рендером
5. Экран показывает пустую болванку

### Стало (решение):

1. Пользователь логинится → `_layout.js` **предварительно загружает профиль**
2. Профиль кэшируется в React Query
3. `orders/index.jsx` ждёт загрузки `role` перед рендером
4. `UniversalHome` рендерится с готовым профилем
5. `readyForCounts` гарантирует синхронизацию всех данных
6. Счётчики загружаются **после** рендера, когда всё готово

## Тестирование

### Сценарий 1: Холодный запуск

```bash
1. Полностью закрыть приложение
2. Запустить заново
3. Авторизоваться
✅ Ожидаемо: Сплэш экран на ~600-1200мс, затем контент с данными
```

### Сценарий 2: Быстрый перезапуск

```bash
1. Находиться на главном экране
2. Выйти из приложения (не logout, а закрыть)
3. Запустить снова за 2-3 секунды
✅ Ожидаемо: Сразу видны данные (из кэша)
```

### Сценарий 3: Смена пользователя

```bash
1. Залогиниться как User A
2. Выйти (logout)
3. Залогиниться как User B
✅ Ожидаемо: Данные User B загружаются, кэш User A очищается
```

## Файлы, которые были изменены

- ✅ `app/_layout.js`
- ✅ `components/universalhome.jsx`
- ✅ `app/orders/index.jsx`

## Результат

- ✅ Холодный запуск показывает контент с данными БД
- ✅ Нет пустых болванок
- ✅ Счётчики заполняются корректно
- ✅ Роль пользователя определяется правильно
- ✅ Данные кэшируются для быстрого переключения между экранами
