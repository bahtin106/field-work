# Профессиональная система деактивации сотрудников

## Архитектура

Реализована Apple-level система деактивации сотрудников с проверкой активных заявок и переназначением. **Никогда не происходит физическое удаление из БД** - все изменения соответствуют требованиям аудита и compliance.

### Компоненты

#### 1. Edge Functions

**`check_employee_orders`** - Проверяет активные заявки сотрудника перед деактивацией
- GET количество активных заявок (не завершённых, не отменённых)
- Возвращает список доступных преемников (активные сотрудники)
- Проверяет права: только admin/dispatcher
- **URL**: `/functions/v1/check_employee_orders`

**`deactivate_employee`** - Деактивирует сотрудника с опциональным переназначением заявок
- Транзакционная операция
- Если указан преемник (reassign_to), переназначает все активные заявки
- Помечает сотрудника как `is_suspended: true` + записывает `suspended_at`
- **Никогда не удаляет** - soft delete для истории аудита
- **URL**: `/functions/v1/deactivate_employee`

#### 2. UI Компоненты

**`DeactivateEmployeeModal`** - Трёхуровневый интерфейс деактивации
1. **Без заявок** (activeOrdersCount = 0):
   - Простое подтверждение деактивации
   - Сообщение: "У сотрудника нет активных заявок..."
   
2. **С заявками, преемник не выбран** (activeOrdersCount > 0 && !successor):
   - Информационное сообщение: "X активных заявок"
   - Кнопка: "Выбрать сотрудника"
   - Открывает SelectModal для выбора преемника
   
3. **С заявками, преемник выбран** (activeOrdersCount > 0 && successor):
   - Финальное подтверждение с деталями
   - Сообщение: "X заявок будет переназначена на [имя]"
   - Кнопка деактивации с красным (destructive) стилем

### Поток пользователя

```
Кнопка "Удалить" в edit.jsx
    ↓
onAskDelete() - вызывает check_employee_orders
    ↓
[Проверка заявок]
    ├─ 0 заявок → DeactivateEmployeeModal (режим 1)
    └─ N заявок → DeactivateEmployeeModal (режим 2)
        ↓
    [Пользователь выбирает преемника]
        ↓
    DeactivateEmployeeModal (режим 3)
        ↓
    onConfirmDelete() - вызывает deactivate_employee
        ↓
    [Деактивация + переназначение]
        ↓
    Возврат на список сотрудников
```

## Реализация в коде

### edit.jsx изменения

```jsx
// Новое состояние для отслеживания заявок
const [activeOrdersCount, setActiveOrdersCount] = useState(0);

// onAskDelete - проверка перед деактивацией
const onAskDelete = async () => {
  // 1. Вызывает check_employee_orders
  // 2. Получает activeOrdersCount и доступных преемников
  // 3. Показывает DeactivateEmployeeModal
};

// onConfirmDelete - финальное подтверждение
const onConfirmDelete = async () => {
  // 1. Вызывает deactivate_employee
  // 2. Переназначает заявки если нужно
  // 3. Помечает как suspended
  // 4. Возвращает на предыдущий экран
};
```

## Примеры запросов

### Check Orders

```bash
curl -X POST https://...supabase.../functions/v1/check_employee_orders \
  -H "Authorization: Bearer {token}" \
  -H "Content-Type: application/json" \
  -d '{"user_id": "550e8400-e29b-41d4-a716-446655440000"}'

Ответ:
{
  "success": true,
  "user": { "id": "...", "first_name": "...", "last_name": "..." },
  "activeOrdersCount": 3,
  "hasOrders": true,
  "availableEmployees": [
    { "id": "...", "first_name": "...", "last_name": "...", "full_name": "...", "role": "worker" }
  ]
}
```

### Deactivate with Reassign

```bash
curl -X POST https://...supabase.../functions/v1/deactivate_employee \
  -H "Authorization: Bearer {token}" \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": "550e8400-e29b-41d4-a716-446655440000",
    "reassign_to": "660e8400-e29b-41d4-a716-446655440001"
  }'

Ответ:
{
  "success": true,
  "message": "Сотрудник деактивирован, заявки переназначены"
}
```

## База данных

### Структура profiles таблицы

Используемые поля:
- `id` (UUID) - Первичный ключ
- `is_suspended` (boolean) - Статус деактивации
- `suspended_at` (timestamp) - Время деактивации
- `first_name`, `last_name`, `full_name` (text) - Данные сотрудника
- `role` (role_enum) - Роль сотрудника

**Важно**: `is_suspended` НИКОГДА не удаляется - только помечается как true. Это позволяет сохранить полную историю:
- Кто создавал заявки
- Кто выполнял работу
- Полный аудит всех операций

### Структура orders таблицы

Используемые поля:
- `assigned_to` (UUID FK) - ID сотрудника
- `status` (order_status_enum) - Статус заявки
  - Активные: 'new', 'in_progress', 'in_feed'
  - Завершённые: 'completed', 'cancelled'

Политика переназначения: **Переназначаются ТОЛЬКО активные заявки** - завершённые и отменённые остаются историческими записями

## Отличия от старой системы

| Аспект | Старая | Новая |
|--------|--------|-------|
| **Удаление** | Физическое (DELETE) | Soft delete (is_suspended = true) |
| **Проверка заявок** | Всегда требует выбор | Проверяет кол-во, показывает UI соответственно |
| **Переназначение** | Всегда требует преемника | Только если есть активные заявки |
| **УХ/История** | Потеря данных | Полная сохранность истории |
| **Согласованность** | Может быть рассинхронизация | Транзакционное переназначение |

## Развёртывание

```bash
# Развернуть обе функции
npx supabase functions deploy check_employee_orders
npx supabase functions deploy deactivate_employee

# Проверить в Supabase Dashboard
# https://supabase.com/dashboard/project/[PROJECT_ID]/functions
```

## Тестирование

### Сценарий 1: Удаление без заявок
1. Открыть сотрудника без активных заявок
2. Нажать "Удалить"
3. ✅ Должно показать простое подтверждение

### Сценарий 2: Удаление с заявками
1. Открыть сотрудника с активными заявками (N > 0)
2. Нажать "Удалить"
3. ✅ Показать кол-во заявок
4. Выбрать преемника
5. ✅ Показать финальное подтверждение с именем
6. Подтвердить
7. ✅ Заявки переназначены, сотрудник деактивирован

### Сценарий 3: Ошибки
1. Если преемник не активен → ошибка "Преемник деактивирован"
2. Если нет доступных преемников → ошибка при поиске
3. Если сотрудник не найден → ошибка 404

## Compliance & Audit

✅ **GDPR/CCPA**: Никогда не удаляются данные пользователя - только помечаются

✅ **Audit Trail**: Каждый шаг записывается:
- `suspended_at` - когда деактивирован
- История заявок связана с сотрудником
- Можно восстановить если нужно

✅ **Transaction Safety**: Переназначение и деактивация - одна транзакция

✅ **Role-based Access**: Только admin может деактивировать сотрудников
