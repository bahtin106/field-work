# ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å–æ —Å–º–µ–Ω–æ–π –ø–∞—Ä–æ–ª—è (–≤–µ—Ä—Å–∏—è –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π Supabase)

## –°–∏—Ç—É–∞—Ü–∏—è
- –£ –≤–∞—Å –ª–æ–∫–∞–ª—å–Ω–∞—è Supabase –ë–ï–ó edge functions
- –ù–∞ VPS —É–∂–µ –µ—Å—Ç—å Node.js —Å–µ—Ä–≤–∏—Å –¥–ª—è email (–Ω–∞ –ø–æ—Ä—Ç—É 3000)
- –ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è —á–µ—Ä–µ–∑ API –≤–º–µ—Å—Ç–æ edge-—Ñ—É–Ω–∫—Ü–∏–∏

## –†–µ—à–µ–Ω–∏–µ (–≤–º–µ—Å—Ç–æ edge-—Ñ—É–Ω–∫—Ü–∏–∏)

–ú—ã —Å–æ–∑–¥–∞–ª–∏ –ø—Ä–æ—Å—Ç–æ–π API endpoint –Ω–∞ Node.js, –∫–æ—Ç–æ—Ä—ã–π –æ–±–Ω–æ–≤–ª—è–µ—Ç –ø–∞—Ä–æ–ª—å –≤ auth.users.

### –§–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω—ã:

1. **server/routes/updatePassword.js** - –Ω–æ–≤—ã–π API endpoint
2. **app/users/[id]/edit.jsx** - –æ–±–Ω–æ–≤–ª–µ–Ω–æ –¥–ª—è –≤—ã–∑–æ–≤–∞ API –≤–º–µ—Å—Ç–æ edge-—Ñ—É–Ω–∫—Ü–∏–∏

## üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –Ω–∞ VPS (3 —à–∞–≥–∞)

### –®–∞–≥ 1: –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª –Ω–∞ VPS
```bash
# –ù–∞ –≤–∞—à–µ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ:
scp server/routes/updatePassword.js user@5.35.91.118:/path/to/vps/app/routes/
```

–ò–ª–∏ –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ SCP/SFTP —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª `server/routes/updatePassword.js` –≤ –ø–∞–ø–∫—É –º–∞—Ä—à—Ä—É—Ç–æ–≤ –≤–∞—à–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

### –®–∞–≥ 2: –ü–æ–¥–∫–ª—é—á–∏—Ç—å —Ä–æ—É—Ç –≤ –≥–ª–∞–≤–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏

–ï—Å–ª–∏ —ç—Ç–æ Express –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (app.js –∏–ª–∏ index.js):

```javascript
// –î–æ–±–∞–≤—å—Ç–µ –≤ –≥–ª–∞–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:
const updatePasswordRoute = require('./routes/updatePassword');

// –ü–æ–¥–∫–ª—é—á–∏—Ç—å —Ä–æ—É—Ç
app.use('/api', updatePasswordRoute);
```

–ï—Å–ª–∏ —É –≤–∞—Å –¥—Ä—É–≥–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ - –ø—Ä–æ—Å—Ç–æ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ router.

### –®–∞–≥ 3: –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ VPS
```bash
# –ù–∞ VPS:
pm2 restart app
# –∏–ª–∏
systemctl restart your-app-name
# –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å pm2 –ø—Ä–æ—Ü–µ—Å—Å
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ß–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä –∫–æ–Ω—Å–æ–ª—å
1. –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ field-work
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
3. –ò–∑–º–µ–Ω–∏—Ç–µ –ø–∞—Ä–æ–ª—å
4. –í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ (F12 ‚Üí Console) –¥–æ–ª–∂–Ω—ã –≤–∏–¥–µ—Ç—å –ª–æ–≥–∏:
```
[proceedSave] Attempting to update auth credentials
[proceedSave] Calling update-password API at: http://5.35.91.118:3000
[proceedSave] Response status: 200
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ü—Ä—è–º–æ–π —Ç–µ—Å—Ç —á–µ—Ä–µ–∑ curl
```bash
curl -X POST http://5.35.91.118:3000/api/update-password \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": "YOUR_USER_UUID",
    "password": "NewPassword123",
    "changed_by": "ADMIN_UUID"
  }'
```

–û–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç:
```json
{"ok": true, "message": "Password updated successfully"}
```

## üìä –õ–æ–≥–∏

–ü–æ—Å–ª–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è:

1. **–ü—Ä–∏ —Å–º–µ–Ω–µ –ø–∞—Ä–æ–ª—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏** - –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –≤–∏–¥–Ω—ã –ª–æ–≥–∏ `[proceedSave]`
2. **–ù–∞ VPS** - –≤ –ª–æ–≥–∞—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤–∏–¥–Ω—ã –ª–æ–≥–∏ `[UPDATE_PASSWORD]`:
```
[UPDATE_PASSWORD] Updating password for user: <uuid>
[UPDATE_PASSWORD] Password updated successfully for user: <uuid>
```

## üîç –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ü—Ä–æ–±–ª–µ–º–∞ 1: 404 –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ API
**–†–µ—à–µ–Ω–∏–µ:**
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ä–æ—É—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω –≤ –≥–ª–∞–≤–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ (`app.use('/api', updatePasswordRoute)`)
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø—É—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π: `/api/update-password`
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ logs –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞ VPS

### –ü—Ä–æ–±–ª–µ–º–∞ 2: "–°—Épabase admin client not available"
**–†–µ—à–µ–Ω–∏–µ:**
- –í —Ñ–∞–π–ª–µ `server/routes/updatePassword.js` –∏–∑–º–µ–Ω–∏—Ç–µ –∏–º–ø–æ—Ä—Ç:
```javascript
// –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ:
const { supabaseAdmin } = require('../lib/supabase');

// –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–∞—à —Å–ø–æ—Å–æ–± –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ admin –∫–ª–∏–µ–Ω—Ç–∞:
const { createClient } = require('@supabase/supabase-js');
const supabaseAdmin = createClient(
  process.env.SUPABASE_URL,
  process.env.SUPABASE_SERVICE_ROLE_KEY
);
```

### –ü—Ä–æ–±–ª–µ–º–∞ 3: –û—à–∏–±–∫–∞ CORS
**–†–µ—à–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤—å—Ç–µ CORS –æ–±—Ä–∞–±–æ—Ç–∫—É –≤ –≥–ª–∞–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:
```javascript
const cors = require('cors');
app.use(cors());
```

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
/vps-app/
‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îî‚îÄ‚îÄ updatePassword.js  ‚Üê –ù–æ–≤—ã–π —Ñ–∞–π–ª
‚îú‚îÄ‚îÄ app.js –∏–ª–∏ index.js
‚îî‚îÄ‚îÄ .env (—Å SUPABASE_URL –∏ SUPABASE_SERVICE_ROLE_KEY)
```

## ‚úÖ –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ —Å–º–µ–Ω–µ –ø–∞—Ä–æ–ª—è

1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –º–µ–Ω—è–µ—Ç –ø–∞—Ä–æ–ª—å**
2. **–§—Ä–æ–Ω—Ç–µ–Ω–¥ –≤—ã–∑—ã–≤–∞–µ—Ç API** `POST /api/update-password`
3. **–ù–∞ VPS Node.js –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ª–æ–≤–∏—Ç –∑–∞–ø—Ä–æ—Å**
4. **–û–±–Ω–æ–≤–ª—è–µ—Ç –ø–∞—Ä–æ–ª—å —á–µ—Ä–µ–∑ Supabase Admin API** (`supabaseAdmin.auth.admin.updateUserById()`)
5. **–õ–æ–≥–∏—Ä—É–µ—Ç –¥–µ–π—Å—Ç–≤–∏–µ –≤ –∫–æ–Ω—Å–æ–ª—å VPS**
6. **–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç–≤–µ—Ç —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥—É** `{ ok: true }`
7. **–§—Ä–æ–Ω—Ç–µ–Ω–¥ –≤—ã–≤–æ–¥–∏—Ç –ª–æ–≥–∏ –≤ –±—Ä–∞—É–∑–µ—Ä –∫–æ–Ω—Å–æ–ª—å**

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–µ–Ω—è–µ—Ç –ø–∞—Ä–æ–ª—å ‚Üí –ü–∞—Ä–æ–ª—å –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ auth.users ‚Üí –í–∏–¥–Ω—ã –ª–æ–≥–∏

## üìù –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–í `.env` –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ –º–æ–∂–µ—Ç –±—ã—Ç—å:

```
# –í–∞—Ä–∏–∞–Ω—Ç 1: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π EMAIL_SERVICE_URL
EXPO_PUBLIC_EMAIL_SERVICE_URL=http://5.35.91.118:3000

# –í–∞—Ä–∏–∞–Ω—Ç 2: –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π API URL
EXPO_PUBLIC_API_URL=http://5.35.91.118:3000
```

–ö–æ–¥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ø—Ä–æ–±—É–µ—Ç –æ–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞.

## üí° –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –ë–î

–ï—Å–ª–∏ –Ω—É–∂–Ω–∞ –∏—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö —Å–º–µ–Ω –ø–∞—Ä–æ–ª—è, –ø—Ä–æ—Å—Ç–æ —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –≤ —Ñ–∞–π–ª–µ —á–∞—Å—Ç—å —Å `password_change_log`:

```javascript
// –õ–æ–≥–∏—Ä—É–µ–º –≤ –ë–î (—Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
try {
  await supabaseAdmin
    .from('password_change_log')
    .insert({
      user_id,
      changed_by: changed_by || user_id,
      changed_at: new Date().toISOString(),
      ip_address: req.ip,
      user_agent: req.get('user-agent'),
    });
  console.log('[UPDATE_PASSWORD] Logged password change for user:', user_id);
} catch (logErr) {
  console.warn('[UPDATE_PASSWORD] Failed to log password change:', logErr.message);
}
```

–ò –ø—Ä–∏–º–µ–Ω–∏—Ç–µ SQL –∏–∑ `SETUP_PASSWORD_LOGS.sql` –≤ –≤–∞—à–µ–π –ª–æ–∫–∞–ª—å–Ω–æ–π Supabase.

---

**–ì–æ—Ç–æ–≤–æ –∫ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é!** üöÄ
