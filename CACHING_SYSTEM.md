> **Status (2026-02-11): Legacy reference.** This document contains historical notes about removed hooks (`useQueryWithCache`, `useRealtimeSync`).
> Current data layer uses TanStack Query feature hooks in `src/features/*` with shared keys in `src/shared/query/queryKeys.ts`.
# РџСЂРѕС„РµСЃСЃРёРѕРЅР°Р»СЊРЅР°СЏ СЃРёСЃС‚РµРјР° РєСЌС€РёСЂРѕРІР°РЅРёСЏ Рё СѓРїСЂР°РІР»РµРЅРёСЏ РґР°РЅРЅС‹РјРё

## вњ… Р§С‚Рѕ СЂРµР°Р»РёР·РѕРІР°РЅРѕ

### 1. Р¦РµРЅС‚СЂР°Р»СЊРЅР°СЏ СЃРёСЃС‚РµРјР° РєСЌС€РёСЂРѕРІР°РЅРёСЏ (`lib/cache/DataCache.js`)

- **TTL (Time To Live)**: РђРІС‚РѕРјР°С‚РёС‡РµСЃРєРѕРµ СѓСЃС‚Р°СЂРµРІР°РЅРёРµ РґР°РЅРЅС‹С…
- **Stale-While-Revalidate**: РџРѕРєР°Р·С‹РІР°РµРј СЃС‚Р°СЂС‹Рµ РґР°РЅРЅС‹Рµ Рё РѕР±РЅРѕРІР»СЏРµРј РІ С„РѕРЅРµ
- **РђРІС‚РѕРјР°С‚РёС‡РµСЃРєР°СЏ РѕС‡РёСЃС‚РєР°**: РЈРґР°Р»РµРЅРёРµ СѓСЃС‚Р°СЂРµРІС€РёС… РґР°РЅРЅС‹С… РєР°Р¶РґСѓСЋ РјРёРЅСѓС‚Сѓ
- **РРЅРІР°Р»РёРґР°С†РёСЏ РїРѕ РїР°С‚С‚РµСЂРЅР°Рј**: РћС‡РёСЃС‚РєР° РєСЌС€Р° РїРѕ РјР°СЃРєРµ (РЅР°РїСЂРёРјРµСЂ, `users:*`)
- **Р“Р»РѕР±Р°Р»СЊРЅС‹Р№ СЌРєР·РµРјРїР»СЏСЂ**: РћРґРёРЅ РєСЌС€ РґР»СЏ РІСЃРµРіРѕ РїСЂРёР»РѕР¶РµРЅРёСЏ

### 2. РЈРЅРёРІРµСЂСЃР°Р»СЊРЅС‹Р№ С…СѓРє `useQueryWithCache` (`components/hooks/useQueryWithCache.js`)

- вњ… **Stale-While-Revalidate СЃС‚СЂР°С‚РµРіРёСЏ**
- вњ… **Р”РµРґСѓРїР»РёРєР°С†РёСЏ Р·Р°РїСЂРѕСЃРѕРІ**: Р•СЃР»Рё Р·Р°РїСЂРѕСЃ СѓР¶Рµ РёРґРµС‚, РІС‚РѕСЂРѕР№ РЅРµ РѕС‚РїСЂР°РІР»СЏРµС‚СЃСЏ
- вњ… **РђРІС‚РѕРјР°С‚РёС‡РµСЃРєРёР№ retry**: 3 РїРѕРїС‹С‚РєРё РїСЂРё РѕС€РёР±РєР°С…
- вњ… **Pull-to-refresh**: Р’СЃС‚СЂРѕРµРЅРЅР°СЏ РїРѕРґРґРµСЂР¶РєР°
- вњ… **РћРїС‚РёРјРёСЃС‚РёС‡РЅС‹Рµ РѕР±РЅРѕРІР»РµРЅРёСЏ**: С‡РµСЂРµР· `mutate()`
- вњ… **Realtime РёРЅС‚РµРіСЂР°С†РёСЏ**: РђРІС‚РѕРјР°С‚РёС‡РµСЃРєР°СЏ СЃРёРЅС…СЂРѕРЅРёР·Р°С†РёСЏ С‡РµСЂРµР· Supabase
- вњ… **Placeholder data**: РџРѕРєР°Р· РґР°РЅРЅС‹С… РґРѕ Р·Р°РіСЂСѓР·РєРё

### 3. РЎРёСЃС‚РµРјР° Realtime СЃРёРЅС…СЂРѕРЅРёР·Р°С†РёРё (`components/hooks/useRealtimeSync.js`)

- вњ… **РЈРјРЅР°СЏ РґРµРґСѓРїР»РёРєР°С†РёСЏ**: РњРЅРѕР¶РµСЃС‚РІРµРЅРЅС‹Рµ РїРѕРґРїРёСЃРєРё РЅР° РѕРґРЅСѓ С‚Р°Р±Р»РёС†Сѓ = РѕРґРёРЅ РєР°РЅР°Р»
- вњ… **РђРІС‚РѕРјР°С‚РёС‡РµСЃРєР°СЏ РѕС‡РёСЃС‚РєР°**: РћС‚РїРёСЃРєР° РїСЂРё СЂР°Р·РјРѕРЅС‚РёСЂРѕРІР°РЅРёРё
- вњ… **РњСѓР»СЊС‚Рё-С‚Р°Р±Р»РёС†Р°**: `useMultiTableSync` РґР»СЏ РЅРµСЃРєРѕР»СЊРєРёС… С‚Р°Р±Р»РёС† СЃСЂР°Р·Сѓ
- вњ… **РђРІС‚РѕРјР°С‚РёС‡РµСЃРєР°СЏ РёРЅРІР°Р»РёРґР°С†РёСЏ РєСЌС€Р°**: РџСЂРё РёР·РјРµРЅРµРЅРёСЏС… РІ Р‘Р”

### 4. РЎРїРµС†РёС„РёС‡РЅС‹Рµ С…СѓРєРё

- вњ… **`useUsers`**: Р”Р»СЏ СЂР°Р±РѕС‚С‹ СЃРѕ СЃРїРёСЃРєРѕРј РїРѕР»СЊР·РѕРІР°С‚РµР»РµР№
- вњ… **`useDepartments`**: Р”Р»СЏ СЂР°Р±РѕС‚С‹ СЃ РѕС‚РґРµР»Р°РјРё

### 5. РћРїС‚РёРјРёР·РёСЂРѕРІР°РЅРЅС‹Рµ СЃС‚СЂР°РЅРёС†С‹

- вњ… **users/index.jsx**: РџРѕР»РЅРѕСЃС‚СЊСЋ РїРµСЂРµРІРµРґРµРЅР° РЅР° РЅРѕРІСѓСЋ СЃРёСЃС‚РµРјСѓ
  - РњРіРЅРѕРІРµРЅРЅР°СЏ Р·Р°РіСЂСѓР·РєР° РїСЂРё РїРѕРІС‚РѕСЂРЅРѕРј Р·Р°С…РѕРґРµ
  - Pull-to-refresh СЂР°Р±РѕС‚Р°РµС‚ РїР»Р°РІРЅРѕ
  - РђРІС‚РѕРјР°С‚РёС‡РµСЃРєРѕРµ РѕР±РЅРѕРІР»РµРЅРёРµ РїСЂРё РёР·РјРµРЅРµРЅРёСЏС…
  - РњРµРЅСЊС€Рµ РєРѕРґР° РЅР° ~150 СЃС‚СЂРѕРє

## рџљЂ РљР°Рє РёСЃРїРѕР»СЊР·РѕРІР°С‚СЊ

### РџСЂРѕСЃС‚РѕР№ РїСЂРёРјРµСЂ (РїРѕР»СЊР·РѕРІР°С‚РµР»Рё)

```javascript
import { useUsers } from '../../components/hooks/useUsers';

function MyComponent() {
  const { users, isLoading, isRefreshing, refresh } = useUsers({
    filters: { roles: ['admin'], suspended: false },
  });

  return (
    <FlatList
      data={users}
      refreshControl={<RefreshControl refreshing={isRefreshing} onRefresh={refresh} />}
    />
  );
}
```

### РџСЂРёРјРµСЂ СЃ РєР°СЃС‚РѕРјРЅС‹Рј Р·Р°РїСЂРѕСЃРѕРј

```javascript
import { useQueryWithCache } from '../../components/hooks/useQueryWithCache';
import { supabase } from '../../lib/supabase';

function OrderDetails({ orderId }) {
  const {
    data: order,
    isLoading,
    refresh,
  } = useQueryWithCache({
    queryKey: `order:${orderId}`,
    queryFn: async () => {
      const { data, error } = await supabase.from('orders').select('*').eq('id', orderId).single();
      if (error) throw error;
      return data;
    },
    ttl: 5 * 60 * 1000, // 5 РјРёРЅСѓС‚
    enabled: !!orderId,
    // РђРІС‚РѕРјР°С‚РёС‡РµСЃРєР°СЏ СЃРёРЅС…СЂРѕРЅРёР·Р°С†РёСЏ С‡РµСЂРµР· Realtime
    enableRealtime: true,
    realtimeTable: 'orders',
    supabaseClient: supabase,
  });

  if (isLoading) return <Loader />;

  return <OrderCard order={order} />;
}
```

### РџСЂРёРјРµСЂ СЃ РѕРїС‚РёРјРёСЃС‚РёС‡РЅС‹РјРё РѕР±РЅРѕРІР»РµРЅРёСЏРјРё

```javascript
function UserProfile() {
  const {
    data: profile,
    mutate,
    refresh,
  } = useQueryWithCache({
    queryKey: 'myProfile',
    queryFn: fetchMyProfile,
  });

  const updateName = async (newName) => {
    // РћРїС‚РёРјРёСЃС‚РёС‡РЅРѕРµ РѕР±РЅРѕРІР»РµРЅРёРµ - СЃСЂР°Р·Сѓ РїРѕРєР°Р·С‹РІР°РµРј РёР·РјРµРЅРµРЅРёСЏ
    mutate((prev) => ({ ...prev, name: newName }));

    try {
      // РЎРѕС…СЂР°РЅСЏРµРј РІ Р‘Р”
      await supabase.from('profiles').update({ name: newName }).eq('id', profile.id);
    } catch (error) {
      // РџСЂРё РѕС€РёР±РєРµ РѕС‚РєР°С‚С‹РІР°РµРј РёР·РјРµРЅРµРЅРёСЏ
      refresh();
    }
  };

  return <ProfileForm profile={profile} onUpdate={updateName} />;
}
```

### РџСЂРёРјРµСЂ СЃ РјРЅРѕР¶РµСЃС‚РІРµРЅРЅС‹РјРё С‚Р°Р±Р»РёС†Р°РјРё

```javascript
import { useMultiTableSync } from '../../components/hooks/useRealtimeSync';

function Dashboard() {
  const { users, refresh: refreshUsers } = useUsers();
  const { orders, refresh: refreshOrders } = useOrders();

  // РђРІС‚РѕРјР°С‚РёС‡РµСЃРєР°СЏ СЃРёРЅС…СЂРѕРЅРёР·Р°С†РёСЏ РѕР±РµРёС… С‚Р°Р±Р»РёС†
  useMultiTableSync({
    supabaseClient: supabase,
    tables: [
      { table: 'profiles', queryKey: 'users', onUpdate: refreshUsers },
      { table: 'orders', queryKey: 'orders', onUpdate: refreshOrders },
    ],
  });

  return <DashboardView users={users} orders={orders} />;
}
```

## вљ™пёЏ РќР°СЃС‚СЂРѕР№РєРё TTL

```javascript
// Р§Р°СЃС‚Рѕ РјРµРЅСЏСЋС‰РёРµСЃСЏ РґР°РЅРЅС‹Рµ
ttl: 1 * 60 * 1000; // 1 РјРёРЅСѓС‚Р° - Р·Р°РєР°Р·С‹, СЃРѕРѕР±С‰РµРЅРёСЏ

// РћР±С‹С‡РЅС‹Рµ РґР°РЅРЅС‹Рµ
ttl: 5 * 60 * 1000; // 5 РјРёРЅСѓС‚ - РїРѕР»СЊР·РѕРІР°С‚РµР»Рё, РїСЂРѕС„РёР»Рё (РїРѕ СѓРјРѕР»С‡Р°РЅРёСЋ)

// Р РµРґРєРѕ РјРµРЅСЏСЋС‰РёРµСЃСЏ РґР°РЅРЅС‹Рµ
ttl: 15 * 60 * 1000; // 15 РјРёРЅСѓС‚ - РѕС‚РґРµР»С‹, РЅР°СЃС‚СЂРѕР№РєРё

// РЎРїСЂР°РІРѕС‡РЅРёРєРё
ttl: 30 * 60 * 1000; // 30 РјРёРЅСѓС‚ - СЂРѕР»Рё, С‚РёРїС‹ СЂР°Р±РѕС‚

// РЎС‚Р°С‚РёС‡РµСЃРєРёРµ РґР°РЅРЅС‹Рµ
ttl: 60 * 60 * 1000; // 1 С‡Р°СЃ - РєРѕРЅСЃС‚Р°РЅС‚С‹, РїРµСЂРµРІРѕРґС‹
```

## рџ“Љ РџСЂРѕРёР·РІРѕРґРёС‚РµР»СЊРЅРѕСЃС‚СЊ

### Р”Рѕ РѕРїС‚РёРјРёР·Р°С†РёРё

- вќЊ Р—Р°РіСЂСѓР·РєР° РїСЂРё РєР°Р¶РґРѕРј Р·Р°С…РѕРґРµ: ~1-2 СЃРµРєСѓРЅРґС‹
- вќЊ РњРµСЂС†Р°РЅРёРµ СЌРєСЂР°РЅР° РїСЂРё РЅР°РІРёРіР°С†РёРё
- вќЊ Р”СѓР±Р»РёСЂРѕРІР°РЅРёРµ Р·Р°РїСЂРѕСЃРѕРІ РїСЂРё Р±С‹СЃС‚СЂРѕР№ РЅР°РІРёРіР°С†РёРё
- вќЊ Realtime РїРѕРґРїРёСЃРєРё РЅРµ РѕС‡РёС‰Р°СЋС‚СЃСЏ в†’ СѓС‚РµС‡РєРё РїР°РјСЏС‚Рё
- вќЊ РќРµС‚ retry РїСЂРё РѕС€РёР±РєР°С… СЃРµС‚Рё

### РџРѕСЃР»Рµ РѕРїС‚РёРјРёР·Р°С†РёРё

- вњ… РњРіРЅРѕРІРµРЅРЅР°СЏ Р·Р°РіСЂСѓР·РєР° РёР· РєСЌС€Р°: 0ms
- вњ… РџР»Р°РІРЅР°СЏ РЅР°РІРёРіР°С†РёСЏ Р±РµР· РјРµСЂС†Р°РЅРёСЏ
- вњ… Р”РµРґСѓРїР»РёРєР°С†РёСЏ: РѕРґРёРЅ Р·Р°РїСЂРѕСЃ РІРјРµСЃС‚Рѕ РЅРµСЃРєРѕР»СЊРєРёС…
- вњ… РђРІС‚РѕРјР°С‚РёС‡РµСЃРєР°СЏ РѕС‡РёСЃС‚РєР° РїРѕРґРїРёСЃРѕРє
- вњ… РЈРјРЅС‹Р№ retry СЃ СЌРєСЃРїРѕРЅРµРЅС†РёР°Р»СЊРЅРѕР№ Р·Р°РґРµСЂР¶РєРѕР№
- вњ… Р¤РѕРЅРѕРІРѕРµ РѕР±РЅРѕРІР»РµРЅРёРµ РЅРµ Р±Р»РѕРєРёСЂСѓРµС‚ UI

## рџ”§ API Reference

### `useQueryWithCache(options)`

**РџР°СЂР°РјРµС‚СЂС‹:**

- `queryKey` (string): РЈРЅРёРєР°Р»СЊРЅС‹Р№ РєР»СЋС‡ РєСЌС€Р°
- `queryFn` (async function): Р¤СѓРЅРєС†РёСЏ Р·Р°РіСЂСѓР·РєРё РґР°РЅРЅС‹С…
- `ttl` (number): Р’СЂРµРјСЏ Р¶РёР·РЅРё РєСЌС€Р° РІ РјСЃ (default: 5 РјРёРЅСѓС‚)
- `enabled` (boolean): Р’РєР»СЋС‡РёС‚СЊ/РІС‹РєР»СЋС‡РёС‚СЊ Р·Р°РїСЂРѕСЃ (default: true)
- `retry` (number): РљРѕР»РёС‡РµСЃС‚РІРѕ РїРѕРІС‚РѕСЂРЅС‹С… РїРѕРїС‹С‚РѕРє (default: 3)
- `retryDelay` (number): Р—Р°РґРµСЂР¶РєР° РјРµР¶РґСѓ РїРѕРїС‹С‚РєР°РјРё РІ РјСЃ (default: 1000)
- `onSuccess` (function): Callback РїСЂРё СѓСЃРїРµС€РЅРѕР№ Р·Р°РіСЂСѓР·РєРµ
- `onError` (function): Callback РїСЂРё РѕС€РёР±РєРµ
- `placeholderData` (any): Р”Р°РЅРЅС‹Рµ РґРѕ Р·Р°РіСЂСѓР·РєРё
- `enableRealtime` (boolean): Р’РєР»СЋС‡РёС‚СЊ Realtime СЃРёРЅС…СЂРѕРЅРёР·Р°С†РёСЋ
- `realtimeTable` (string): РўР°Р±Р»РёС†Р° РґР»СЏ Realtime
- `supabaseClient` (object): Р­РєР·РµРјРїР»СЏСЂ Supabase РєР»РёРµРЅС‚Р°

**Р’РѕР·РІСЂР°С‰Р°РµС‚:**

- `data`: Р—Р°РіСЂСѓР¶РµРЅРЅС‹Рµ РґР°РЅРЅС‹Рµ
- `isLoading`: РРґРµС‚ Р»Рё Р·Р°РіСЂСѓР·РєР° (С‚РѕР»СЊРєРѕ РїСЂРё РїРµСЂРІРѕРј Р·Р°РїСЂРѕСЃРµ)
- `isRefreshing`: РРґРµС‚ Р»Рё refresh (pull-to-refresh)
- `isFetching`: РРґРµС‚ Р»Рё С„РѕРЅРѕРІР°СЏ Р·Р°РіСЂСѓР·РєР°
- `error`: РћР±СЉРµРєС‚ РѕС€РёР±РєРё (РµСЃР»Рё РµСЃС‚СЊ)
- `refresh`: Р¤СѓРЅРєС†РёСЏ РґР»СЏ РїСЂРёРЅСѓРґРёС‚РµР»СЊРЅРѕРіРѕ РѕР±РЅРѕРІР»РµРЅРёСЏ
- `refetch`: РђР»РёР°СЃ РґР»СЏ `refresh`
- `mutate`: Р¤СѓРЅРєС†РёСЏ РґР»СЏ РѕРїС‚РёРјРёСЃС‚РёС‡РЅС‹С… РѕР±РЅРѕРІР»РµРЅРёР№
- `invalidate`: Р¤СѓРЅРєС†РёСЏ РґР»СЏ РёРЅРІР°Р»РёРґР°С†РёРё РєСЌС€Р°

### `useRealtimeSync(options)`

**РџР°СЂР°РјРµС‚СЂС‹:**

- `supabaseClient` (object): Р­РєР·РµРјРїР»СЏСЂ Supabase РєР»РёРµРЅС‚Р°
- `table` (string): РќР°Р·РІР°РЅРёРµ С‚Р°Р±Р»РёС†С‹
- `queryKey` (string): РљР»СЋС‡ РєСЌС€Р° РґР»СЏ РёРЅРІР°Р»РёРґР°С†РёРё
- `onUpdate` (function): Callback РїСЂРё РёР·РјРµРЅРµРЅРёСЏС…
- `channel` (string): РРјСЏ РєР°РЅР°Р»Р° (optional)
- `enabled` (boolean): Р’РєР»СЋС‡РёС‚СЊ/РІС‹РєР»СЋС‡РёС‚СЊ СЃРёРЅС…СЂРѕРЅРёР·Р°С†РёСЋ
- `events` (array): РњР°СЃСЃРёРІ СЃРѕР±С‹С‚РёР№ ['INSERT', 'UPDATE', 'DELETE', '*']

## рџЋЇ Р РµРєРѕРјРµРЅРґР°С†РёРё

### DO вњ…

- РСЃРїРѕР»СЊР·РѕРІР°С‚СЊ `useQueryWithCache` РґР»СЏ РІСЃРµС… Р·Р°РїСЂРѕСЃРѕРІ Рє Р‘Р”
- Р’РєР»СЋС‡Р°С‚СЊ РІ `queryKey` РІСЃРµ РїР°СЂР°РјРµС‚СЂС‹, РІР»РёСЏСЋС‰РёРµ РЅР° РґР°РЅРЅС‹Рµ
- РСЃРїРѕР»СЊР·РѕРІР°С‚СЊ Realtime РґР»СЏ С‡Р°СЃС‚Рѕ РѕР±РЅРѕРІР»СЏРµРјС‹С… РґР°РЅРЅС‹С…
- РќР°СЃС‚СЂР°РёРІР°С‚СЊ TTL РІ Р·Р°РІРёСЃРёРјРѕСЃС‚Рё РѕС‚ С‡Р°СЃС‚РѕС‚С‹ РёР·РјРµРЅРµРЅРёР№
- РСЃРїРѕР»СЊР·РѕРІР°С‚СЊ `mutate()` РґР»СЏ РѕРїС‚РёРјРёСЃС‚РёС‡РЅС‹С… РѕР±РЅРѕРІР»РµРЅРёР№

### DON'T вќЊ

- РќРµ РёСЃРїРѕР»СЊР·РѕРІР°С‚СЊ РѕРґРёРЅР°РєРѕРІС‹Рµ `queryKey` РґР»СЏ СЂР°Р·РЅС‹С… РґР°РЅРЅС‹С…
- РќРµ Р·Р°Р±С‹РІР°С‚СЊ РїСЂРѕ `enabled` РґР»СЏ СѓСЃР»РѕРІРЅС‹С… Р·Р°РїСЂРѕСЃРѕРІ
- РќРµ СѓСЃС‚Р°РЅР°РІР»РёРІР°С‚СЊ СЃР»РёС€РєРѕРј РєРѕСЂРѕС‚РєРёР№ TTL (< 30 СЃРµРєСѓРЅРґ)
- РќРµ РґРµР»Р°С‚СЊ СЂСѓС‡РЅС‹Рµ РїРѕРґРїРёСЃРєРё РЅР° Realtime (РёСЃРїРѕР»СЊР·СѓР№С‚Рµ С…СѓРєРё)
- РќРµ Р·Р°Р±С‹РІР°С‚СЊ РѕР±СЂР°Р±Р°С‚С‹РІР°С‚СЊ `isLoading` СЃРѕСЃС‚РѕСЏРЅРёРµ

## рџђ› РћС‚Р»Р°РґРєР°

### РџСЂРѕРІРµСЂРёС‚СЊ СЃРѕСЃС‚РѕСЏРЅРёРµ РєСЌС€Р°

```javascript
import { globalCache } from '../lib/cache/DataCache';

// РџРѕР»СѓС‡РёС‚СЊ СЃС‚Р°С‚РёСЃС‚РёРєСѓ
console.log(globalCache.getStats());
// { total: 15, fresh: 10, stale: 5 }

// РџСЂРѕРІРµСЂРёС‚СЊ РєРѕРЅРєСЂРµС‚РЅС‹Р№ РєР»СЋС‡
const cached = globalCache.get('users');
console.log(cached);
// { data: [...], isStale: false, timestamp: 1234567890, age: 30000 }

// РћС‡РёСЃС‚РёС‚СЊ РєСЌС€
globalCache.clear();
```

### Р›РѕРіРёСЂРѕРІР°РЅРёРµ Р·Р°РїСЂРѕСЃРѕРІ

```javascript
const { data } = useQueryWithCache({
  queryKey: 'myData',
  queryFn: fetchData,
  onSuccess: (data) => {
    console.log('Data loaded:', data);
  },
  onError: (error) => {
    console.error('Load error:', error);
  },
});
```

## рџ“ќ РЎР»РµРґСѓСЋС‰РёРµ С€Р°РіРё

Р”Р»СЏ РїСЂРёРјРµРЅРµРЅРёСЏ СЃРёСЃС‚РµРјС‹ Рє РґСЂСѓРіРёРј СЃС‚СЂР°РЅРёС†Р°Рј СЃРј. `OPTIMIZATION_GUIDE.md`

---

**РЎРѕР·РґР°РЅРѕ:** 14 РЅРѕСЏР±СЂСЏ 2025  
**Р’РµСЂСЃРёСЏ:** 1.0.0  
**РЎС‚Р°С‚СѓСЃ:** вњ… Production Ready
