> **Status (2026-02-11): Legacy reference.** This document contains historical notes about removed hooks (`useQueryWithCache`, `useRealtimeSync`).
> Current data layer uses TanStack Query feature hooks in `src/features/*` with shared keys in `src/shared/query/queryKeys.ts`.
# РСЃРїСЂР°РІР»РµРЅРёРµ РІР°СЂРЅРёРЅРіРѕРІ Р°РІС‚РѕСЂРёР·Р°С†РёРё

## РџСЂРѕР±Р»РµРјС‹ РґРѕ РёСЃРїСЂР°РІР»РµРЅРёСЏ

### 1. вќЊ WARN: `Auth session missing!`

**РџСЂРёС‡РёРЅР°:** `useRealtimeSync` РїС‹С‚Р°Р»СЃСЏ РїРѕРґРїРёСЃР°С‚СЊСЃСЏ РЅР° Realtime СЃРѕР±С‹С‚РёСЏ РґРѕ С‚РѕРіРѕ, РєР°Рє РїРѕР»СЊР·РѕРІР°С‚РµР»СЊ Р±С‹Р» Р°СѓС‚РµРЅС‚РёС„РёС†РёСЂРѕРІР°РЅ.

**Р“РґРµ РїСЂРѕРёСЃС…РѕРґРёР»Р° РѕС€РёР±РєР°:**

- Supabase Realtime С‚СЂРµР±СѓРµС‚ Р°СѓС‚РµРЅС‚РёС„РёС†РёСЂРѕРІР°РЅРЅРѕР№ СЃРµСЃСЃРёРё РґР»СЏ `postgres_changes`
- РљРѕРјРїРѕРЅРµРЅС‚ РёРЅРёС†РёР°Р»РёР·РёСЂРѕРІР°Р» realtime РїРѕРґРїРёСЃРєСѓ РЅР° РІСЃРµС… СЃРєСЂРёРЅР°С… СЃСЂР°Р·Сѓ РїСЂРё Р·Р°РіСЂСѓР·РєРµ
- Auth СЃРµСЃСЃРёСЏ Р·Р°РіСЂСѓР¶Р°РµС‚СЃСЏ Р°СЃРёРЅС…СЂРѕРЅРЅРѕ РёР· AsyncStorage (РјРѕР¶РµС‚ Р·Р°РЅСЏС‚СЊ РЅРµСЃРєРѕР»СЊРєРѕ СЃРѕС‚РµРЅ РјСЃ)

### 2. вќЊ WARN: `Initial fetch failed: permission denied for table profiles`

**РџСЂРёС‡РёРЅР°:** РўР°Р±Р»РёС†Р° `profiles` РёРјРµРµС‚ RLS РїРѕР»РёС‚РёРєСѓ, РєРѕС‚РѕСЂР°СЏ С‚СЂРµР±СѓРµС‚ Р°СѓС‚РµРЅС‚РёС„РёРєР°С†РёРё.

**Р“РґРµ РїСЂРѕРёСЃС…РѕРґРёР»Р° РѕС€РёР±РєР°:**

- `useQueryWithCache` РѕС‚РїСЂР°РІР»СЏР» Р·Р°РїСЂРѕСЃ Рє `profiles` Р”Рћ С‚РѕРіРѕ, РєР°Рє СЃРµСЃСЃРёСЏ Р±С‹Р»Р° Р·Р°РіСЂСѓР¶РµРЅР°
- РђРЅРѕРЅРёРј РєР»СЋС‡ РЅРµ РёРјРµРµС‚ РїСЂР°РІ РЅР° `SELECT FROM profiles`
- RLS РїРѕР»РёС‚РёРєР° РІС‹РїРѕР»РЅСЏРµС‚СЃСЏ СЂР°РЅСЊС€Рµ, С‡РµРј РїСЂРѕРІРµСЂРєР° РїСЂР°РІ

---

## Р РµС€РµРЅРёРµ

### вњ… РСЃРїСЂР°РІР»РµРЅРёРµ 1: `useRealtimeSync.js`

```javascript
// Р“Р»РѕР±Р°Р»СЊРЅС‹Р№ С„Р»Р°Рі Р°СѓС‚РµРЅС‚РёС„РёРєР°С†РёРё РґР»СЏ РІСЃРµС… realtime РїРѕРґРїРёСЃРѕРє
let globalAuthStatus = { isAuthenticated: false, checked: false };

export function useRealtimeSync(options) {
  // ... РєРѕРґ ...

  // 1. РџСЂРѕРІРµСЂСЏРµРј СЃС‚Р°С‚СѓСЃ Р°СѓС‚РµРЅС‚РёС„РёРєР°С†РёРё РѕРґРёРЅ СЂР°Р· РїСЂРё РёРЅРёС†РёР°Р»РёР·Р°С†РёРё
  useEffect(() => {
    if (!enabled || !supabaseClient) return;

    if (globalAuthStatus.checked) {
      if (mountedRef.current) {
        setIsAuthChecked(true);
      }
      return;
    }

    const checkAuth = async () => {
      try {
        const { data } = await supabaseClient.auth.getSession();
        globalAuthStatus.isAuthenticated = !!data?.session;
      } catch (err) {
        globalAuthStatus.isAuthenticated = false;
      } finally {
        globalAuthStatus.checked = true;
        if (mountedRef.current) {
          setIsAuthChecked(true);
        }
      }
    };

    checkAuth();
  }, [enabled, supabaseClient]);

  // 2. РџРѕРґРїРёСЃС‹РІР°РµРјСЃСЏ РЅР° realtime РўРћР›Р¬РљРћ РµСЃР»Рё РїРѕР»СЊР·РѕРІР°С‚РµР»СЊ Р°СѓС‚РµРЅС‚РёС„РёС†РёСЂРѕРІР°РЅ
  useEffect(() => {
    if (
      !enabled ||
      !supabaseClient ||
      !table ||
      !isAuthChecked ||
      !globalAuthStatus.isAuthenticated
    ) {
      return; // в¬…пёЏ РќРµ РїРѕРґРїРёСЃС‹РІР°РµРјСЃСЏ РµСЃР»Рё РЅРµС‚ Р°СѓС‚РµРЅС‚РёС„РёРєР°С†РёРё
    }

    // ... РѕСЃС‚Р°Р»СЊРЅРѕР№ РєРѕРґ РїРѕРґРїРёСЃРєРё ...
  }, [enabled, supabaseClient, table, queryKey, channelName, events, isAuthChecked]);
}
```

**Р§С‚Рѕ РёСЃРїСЂР°РІР»СЏРµС‚:**

- вњ… РџСЂРѕРІРµСЂСЏРµС‚ СЃРµСЃСЃРёСЋ РџР•Р Р•Р” РїРѕРїС‹С‚РєРѕР№ РїРѕРґРїРёСЃРєРё РЅР° realtime
- вњ… РРіРЅРѕСЂРёСЂСѓРµС‚ РІР°СЂРЅРёРЅРі "Auth session missing"
- вњ… Graceful fallback - РµСЃР»Рё auth РЅРµРґРѕСЃС‚СѓРїРЅР°, РїСЂРѕСЃС‚Рѕ РЅРµ РїРѕРґРїРёСЃС‹РІР°РµРјСЃСЏ РЅР° realtime (СЂРµРіСѓР»СЏСЂРЅР°СЏ Р·Р°РіСЂСѓР·РєР° Р±СѓРґРµС‚ СЂР°Р±РѕС‚Р°С‚СЊ)

### вњ… РСЃРїСЂР°РІР»РµРЅРёРµ 2: `useQueryWithCache.js`

```javascript
const fetchData = useCallback(
  async (options = {}) => {
    // ... РєРѕРґ ...

    // РџСЂРѕРІРµСЂСЏРµРј Р°СѓС‚РµРЅС‚РёС„РёРєР°С†РёСЋ РїРµСЂРµРґ Р·Р°РїСЂРѕСЃРѕРј Рє profiles
    try {
      if (!isRefresh && !skipCache) {
        const client = supabase || supabaseClient;
        const { data: sessionData } = await client?.auth?.getSession?.();

        // Р•СЃР»Рё РїРѕР»СЊР·РѕРІР°С‚РµР»СЊ РЅРµ Р·Р°Р»РѕРіРёРЅРµРЅ Рё Р·Р°РїСЂР°С€РёРІР°РµРј protected С‚Р°Р±Р»РёС†Сѓ
        if (!sessionData?.session && queryKey.includes('profiles')) {
          // РСЃРїРѕР»СЊР·СѓРµРј РєСЌС€ РµСЃР»Рё РµСЃС‚СЊ
          const cached = globalCache.get(queryKey, staleTime);
          if (cached?.data) {
            // ... РІРµСЂРЅСѓС‚СЊ РєСЌС€РёСЂРѕРІР°РЅРЅС‹Рµ РґР°РЅРЅС‹Рµ ...
            return cached.data;
          }
          // РРЅР°С‡Рµ РЅРµ РґРµР»Р°РµРј Р·Р°РїСЂРѕСЃ - Р¶РґРµРј auth
          if (mountedRef.current) {
            setIsLoading(false);
            setError(new Error('Not authenticated'));
          }
          return null;
        }
      }
    } catch (err) {
      // РРіРЅРѕСЂРёСЂСѓРµРј РѕС€РёР±РєРё РїСЂРѕРІРµСЂРєРё СЃРµСЃСЃРёРё
    }

    // ... РѕСЃС‚Р°Р»СЊРЅРѕР№ РєРѕРґ Р·Р°РіСЂСѓР·РєРё ...
  },
  [queryKey, queryFn, ttl, staleTime, retry, retryDelay, onSuccess, onError],
);
```

**Р§С‚Рѕ РёСЃРїСЂР°РІР»СЏРµС‚:**

- вњ… РџСЂРѕРІРµСЂСЏРµС‚ РЅР°Р»РёС‡РёРµ СЃРµСЃСЃРёРё РџР•Р Р•Р” Р·Р°РїСЂРѕСЃРѕРј Рє `profiles`
- вњ… РќРµ РѕС‚РїСЂР°РІР»СЏРµС‚ Р·Р°РїСЂРѕСЃ РµСЃР»Рё РїРѕР»СЊР·РѕРІР°С‚РµР»СЊ РЅРµ Р°СѓС‚РµРЅС‚РёС„РёС†РёСЂРѕРІР°РЅ
- вњ… РџСЂРµРґРѕС‚РІСЂР°С‰Р°РµС‚ РѕС€РёР±РєСѓ RLS "permission denied"
- вњ… РСЃРїРѕР»СЊР·СѓРµС‚ РєСЌС€ РµСЃР»Рё РµСЃС‚СЊ, РІРјРµСЃС‚Рѕ РѕС€РёР±РєРё

### вњ… РСЃРїСЂР°РІР»РµРЅРёРµ 3: `useUsers.js`

```javascript
const { data, isLoading, isRefreshing, refresh, error } = useQueryWithCache({
  queryKey,
  queryFn: fetchUsers,
  ttl: 5 * 60 * 1000,
  staleTime: 2 * 60 * 1000,
  enabled,
  placeholderData: [],
  supabase, // в¬…пёЏ РџРµСЂРµРґР°РµРј РґР»СЏ РїСЂРѕРІРµСЂРєРё Р°СѓС‚РµРЅС‚РёС„РёРєР°С†РёРё
});
```

---

## РљР°Рє СЌС‚Рѕ СЂР°Р±РѕС‚Р°РµС‚ С‚РµРїРµСЂСЊ

### РЎС†РµРЅР°СЂРёР№ 1: РџСЂРёР»РѕР¶РµРЅРёРµ С‚РѕР»СЊРєРѕ Р·Р°РїСѓСЃС‚РёР»РѕСЃСЊ

1. РџРѕР»СЊР·РѕРІР°С‚РµР»СЊ РµС‰Рµ РЅРµ Р·Р°Р»РѕРіРёРЅРµРЅ (СЃРµСЃСЃРёСЏ Р·Р°РіСЂСѓР¶Р°РµС‚СЃСЏ РёР· AsyncStorage)
2. `useRealtimeSync` РїСЂРѕРІРµСЂСЏРµС‚ Р°СѓС‚РµРЅС‚РёС„РёРєР°С†РёСЋ в†’ `isAuthenticated = false`
3. Realtime РїРѕРґРїРёСЃРєР° **РќР• СЃРѕР·РґР°РµС‚СЃСЏ** (РЅРµС‚ РІР°СЂРЅРёРЅРіР°! вњ…)
4. `useQueryWithCache` РїСЂРѕРІРµСЂСЏРµС‚ Р°СѓС‚РµРЅС‚РёС„РёРєР°С†РёСЋ в†’ РїСЂРѕРїСѓСЃРєР°РµС‚ Р·Р°РїСЂРѕСЃ
5. РџРѕРєР°Р·С‹РІР°РµРј `placeholderData: []` (РїСѓСЃС‚РѕР№ СЃРїРёСЃРѕРє)

### РЎС†РµРЅР°СЂРёР№ 2: РџРѕР»СЊР·РѕРІР°С‚РµР»СЊ Р·Р°Р»РѕРіРёРЅРёР»СЃСЏ

1. РЎРµСЃСЃРёСЏ Р·Р°РіСЂСѓР¶РµРЅР° РёР· AsyncStorage
2. `useRealtimeSync` РїСЂРѕРІРµСЂСЏРµС‚ Р°СѓС‚РµРЅС‚РёС„РёРєР°С†РёСЋ в†’ `isAuthenticated = true`
3. Realtime РїРѕРґРїРёСЃРєР° **СЃРѕР·РґР°РµС‚СЃСЏ СѓСЃРїРµС€РЅРѕ** (РЅРµС‚ РІР°СЂРЅРёРЅРіР°! вњ…)
4. `useQueryWithCache` РїСЂРѕРІРµСЂСЏРµС‚ Р°СѓС‚РµРЅС‚РёС„РёРєР°С†РёСЋ в†’ РґРµР»Р°РµС‚ Р·Р°РїСЂРѕСЃ
5. Р”Р°РЅРЅС‹Рµ Р·Р°РіСЂСѓР¶Р°СЋС‚СЃСЏ Рё РєСЌС€РёСЂСѓСЋС‚СЃСЏ

### РЎС†РµРЅР°СЂРёР№ 3: РЎРµСЃСЃРёСЏ РёСЃС‚РµРєР»Р°/РїРѕР»СЊР·РѕРІР°С‚РµР»СЊ РІС‹С€РµР»

1. РЎРµСЃСЃРёСЏ СѓРґР°Р»РµРЅР°
2. Realtime РїРѕРґРїРёСЃРєР° Р±СѓРґРµС‚ РїРµСЂРµРїРѕРґРїРёСЃР°РЅР° СЃРѕ СЃР»РµРґСѓСЋС‰РёРј С†РёРєР»РѕРј effect
3. `useQueryWithCache` Р±СѓРґРµС‚ РёСЃРїРѕР»СЊР·РѕРІР°С‚СЊ РєСЌС€ РµСЃР»Рё РµСЃС‚СЊ, РёРЅР°С‡Рµ РїСѓСЃС‚РѕР№ СЃРїРёСЃРѕРє
4. РќРµС‚ РѕС€РёР±РѕРє! вњ…

---

## Р РµР·СѓР»СЊС‚Р°С‚

| РџСЂРѕР±Р»РµРјР°                               | Р‘С‹Р»Рѕ                  | РЎС‚Р°Р»Рѕ                       |
| -------------------------------------- | --------------------- | --------------------------- |
| `Auth session missing!`                | вќЊ WARN РІ РєРѕРЅСЃРѕР»Рё     | вњ… РќРµС‚ РІР°СЂРЅРёРЅРіР°             |
| `permission denied for table profiles` | вќЊ WARN РІ РєРѕРЅСЃРѕР»Рё     | вњ… РќРµС‚ РІР°СЂРЅРёРЅРіР°             |
| Realtime РІ РѕС„С„Р»Р°Р№РЅРµ                    | вќЊ РћС€РёР±РєР°             | вњ… Graceful fallback        |
| RLS РѕС€РёР±РєРё                             | вќЊ Р’РёРґРЅС‹ РїРѕР»СЊР·РѕРІР°С‚РµР»СЋ | вњ… РЎРєСЂС‹С‚С‹, РёСЃРїРѕР»СЊР·СѓРµС‚СЃСЏ РєСЌС€ |
| Р¤СѓРЅРєС†РёРѕРЅР°Р»СЊРЅРѕСЃС‚СЊ                       | вњ… Р Р°Р±РѕС‚Р°РµС‚           | вњ… Р Р°Р±РѕС‚Р°РµС‚ Р»СѓС‡С€Рµ           |

---

## Р—Р°РїРѕРјРЅРёС‚Рµ

вњ… **Р’СЃРµРіРґР° РїСЂРѕРІРµСЂСЏР№С‚Рµ Р°СѓС‚РµРЅС‚РёС„РёРєР°С†РёСЋ РїРµСЂРµРґ:**

- Realtime РїРѕРґРїРёСЃРєР°РјРё
- Р—Р°РїСЂРѕСЃР°РјРё Рє Р·Р°С‰РёС‰РµРЅРЅС‹Рј С‚Р°Р±Р»РёС†Р°Рј (РіРґРµ РµСЃС‚СЊ RLS)

вњ… **Р’СЃРµРіРґР° РёСЃРїРѕР»СЊР·СѓР№С‚Рµ РєСЌС€ РєР°Рє fallback:**

- РљРѕРіРґР° РїРѕР»СЊР·РѕРІР°С‚РµР»СЊ РѕС„С„Р»Р°Р№РЅ
- РљРѕРіРґР° auth РµС‰Рµ Р·Р°РіСЂСѓР¶Р°РµС‚СЃСЏ
- РљРѕРіРґР° API РЅРµРґРѕСЃС‚СѓРїРµРЅ

вњ… **Graceful degradation:**

- РџРѕРєР°Р·С‹РІР°РµРј РґР°РЅРЅС‹Рµ РµСЃР»Рё РµСЃС‚СЊ РєСЌС€
- РџРѕРєР°Р·С‹РІР°РµРј РїСѓСЃС‚РѕР№ СЃРїРёСЃРѕРє РµСЃР»Рё РЅРµС‚
- РќРµ РїРѕРєР°Р·С‹РІР°РµРј С‚РµС…РЅРёС‡РµСЃ РѕС€РёР±РєРё РїРѕР»СЊР·РѕРІР°С‚РµР»СЋ
