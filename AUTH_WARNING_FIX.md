> **Status (2026-02-11): Legacy reference.** This document contains historical notes about removed hooks (`useQueryWithCache`, `useRealtimeSync`).
> Current data layer uses TanStack Query feature hooks in `src/features/*` with shared keys in `src/shared/query/queryKeys.ts`.
# рџ”§ РСЃРїСЂР°РІР»РµРЅРёРµ РІР°СЂРЅРёРЅРіРѕРІ Р°РІС‚РѕСЂРёР·Р°С†РёРё Supabase

## РџСЂРѕР±Р»РµРјР°

РџСЂРёР»РѕР¶РµРЅРёРµ РІС‹РІРѕРґРёР»Рѕ РґРІР° РІР°СЂРЅРёРЅРіР° РїСЂРё Р·Р°РіСЂСѓР·РєРµ:

```
WARN  refresh error: Auth session missing!
WARN  Initial fetch failed: permission denied for table profiles
```

## РџСЂРёС‡РёРЅР°

1. **`Auth session missing!`** - `useRealtimeSync` РїС‹С‚Р°Р»СЃСЏ СЃРѕР·РґР°С‚СЊ РїРѕРґРїРёСЃРєСѓ РЅР° Realtime СЃРѕР±С‹С‚РёСЏ Р‘Р•Р— Р°СѓС‚РµРЅС‚РёС„РёРєР°С†РёРё
   - Realtime С‚СЂРµР±СѓРµС‚ РґРµР№СЃС‚РІРёС‚РµР»СЊРЅСѓСЋ СЃРµСЃСЃРёСЋ РґР»СЏ `postgres_changes`
   - РџРѕРґРїРёСЃРєР° СЃРѕР·РґР°РІР°Р»Р°СЃСЊ РґРѕ Р·Р°РіСЂСѓР·РєРё СЃРµСЃСЃРёРё РёР· AsyncStorage

2. **`permission denied for table profiles`** - Р·Р°РїСЂРѕСЃ Рє Р·Р°С‰РёС‰РµРЅРЅРѕР№ С‚Р°Р±Р»РёС†Рµ РѕС‚РїСЂР°РІР»СЏР»СЃСЏ Р‘Р•Р— Р°СѓС‚РµРЅС‚РёС„РёРєР°С†РёРё
   - РўР°Р±Р»РёС†Р° РёРјРµРµС‚ RLS (Row Level Security) РїРѕР»РёС‚РёРєСѓ
   - РђРЅРѕРЅРёРј РєР»СЋС‡ РЅРµ РёРјРµРµС‚ РїСЂР°РІ РЅР° РґРѕСЃС‚СѓРї

## вњ… Р РµС€РµРЅРёРµ

### 1. `useRealtimeSync.js` - РґРѕР±Р°РІР»РµРЅР° РїСЂРѕРІРµСЂРєР° Р°СѓС‚РµРЅС‚РёС„РёРєР°С†РёРё

```javascript
// Р“Р»РѕР±Р°Р»СЊРЅС‹Р№ СЃС‚Р°С‚СѓСЃ Р°СѓС‚РµРЅС‚РёС„РёРєР°С†РёРё
let globalAuthStatus = { isAuthenticated: false, checked: false };

// РџСЂРѕРІРµСЂСЏРµРј СЃРµСЃСЃРёСЋ РїРµСЂРµРґ РїРѕРґРїРёСЃРєРѕР№
const checkAuth = async () => {
  const { data } = await supabaseClient.auth.getSession();
  globalAuthStatus.isAuthenticated = !!data?.session;
};

// РџРѕРґРїРёСЃС‹РІР°РµРјСЃСЏ РўРћР›Р¬РљРћ РµСЃР»Рё РїРѕР»СЊР·РѕРІР°С‚РµР»СЊ Р°СѓС‚РµРЅС‚РёС„РёС†РёСЂРѕРІР°РЅ
if (!globalAuthStatus.isAuthenticated) return;
```

**Р РµР·СѓР»СЊС‚Р°С‚:** вњ… NРµС‚ РІР°СЂРЅРёРЅРіР° "Auth session missing!"

### 2. `useQueryWithCache.js` - РґРѕР±Р°РІР»РµРЅР° РїСЂРѕРІРµСЂРєР° РїРµСЂРµРґ Р·Р°РїСЂРѕСЃРѕРј

```javascript
// РџСЂРѕРІРµСЂСЏРµРј Р°СѓС‚РµРЅС‚РёС„РёРєР°С†РёСЋ РїРµСЂРµРґ Р·Р°РїСЂРѕСЃРѕРј Рє profiles
const { data: sessionData } = await supabase?.auth?.getSession?.();

// РќРµ РґРµР»Р°РµРј Р·Р°РїСЂРѕСЃ РµСЃР»Рё РЅРµС‚ Р°СѓС‚РµРЅС‚РёС„РёРєР°С†РёРё
if (!sessionData?.session && queryKey.includes('profiles')) {
  // РСЃРїРѕР»СЊР·СѓРµРј РєСЌС€ РµСЃР»Рё РµСЃС‚СЊ, РёРЅР°С‡Рµ РїРѕРєР°Р·С‹РІР°РµРј РїСѓСЃС‚РѕР№ СЃРїРёСЃРѕРє
  return cached?.data || [];
}
```

**Р РµР·СѓР»СЊС‚Р°С‚:** вњ… РќРµС‚ РѕС€РёР±РєРё "permission denied"

### 3. `useUsers.js` - РїРµСЂРµРґР°С‡Р° supabase РєР»РёРµРЅС‚Р°

```javascript
const { data, ... } = useQueryWithCache({
  // ...
  supabase, // в†ђ РїРµСЂРµРґР°РµРј РґР»СЏ РїСЂРѕРІРµСЂРєРё Р°СѓС‚РµРЅС‚РёС„РёРєР°С†РёРё
});
```

## рџ“Љ Р РµР·СѓР»СЊС‚Р°С‚С‹

| РЎС‚Р°С‚СѓСЃ                          | Р”Рѕ          | РџРѕСЃР»Рµ             |
| ------------------------------- | ----------- | ----------------- |
| Р’Р°СЂРЅРёРЅРі "Auth session missing!" | вќЊ Р•СЃС‚СЊ     | вњ… РќРµС‚            |
| РћС€РёР±РєР° "permission denied"      | вќЊ Р•СЃС‚СЊ     | вњ… РќРµС‚            |
| Р—Р°РіСЂСѓР·РєР° РґР°РЅРЅС‹С…                 | вњ… Р Р°Р±РѕС‚Р°РµС‚ | вњ… Р Р°Р±РѕС‚Р°РµС‚       |
| Realtime СЃРёРЅС…СЂРѕРЅРёР·Р°С†РёСЏ          | вњ… Р Р°Р±РѕС‚Р°РµС‚ | вњ… Р Р°Р±РѕС‚Р°РµС‚ Р»СѓС‡С€Рµ |

## рџЋЇ РљР°Рє СЌС‚Рѕ СЂР°Р±РѕС‚Р°РµС‚

**РЎС†РµРЅР°СЂРёР№: РџСЂРёР»РѕР¶РµРЅРёРµ Р·Р°РїСѓСЃС‚РёР»РѕСЃСЊ**

1. РџРѕР»СЊР·РѕРІР°С‚РµР»СЊ РµС‰Рµ РЅРµ Р·Р°Р»РѕРіРёРЅРµРЅ (СЃРµСЃСЃРёСЏ Р·Р°РіСЂСѓР¶Р°РµС‚СЃСЏ)
2. вњ… `useRealtimeSync` РїСЂРѕРІРµСЂСЏРµС‚ в†’ РЅРµС‚ СЃРµСЃСЃРёРё в†’ РЅРµ СЃРѕР·РґР°РµС‚ РїРѕРґРїРёСЃРєСѓ
3. вњ… `useQueryWithCache` РїСЂРѕРІРµСЂСЏРµС‚ в†’ РЅРµС‚ СЃРµСЃСЃРёРё в†’ РЅРµ РґРµР»Р°РµС‚ Р·Р°РїСЂРѕСЃ
4. вњ… РџРѕРєР°Р·С‹РІР°РµРј РїСѓСЃС‚РѕР№ СЃРїРёСЃРѕРє (placeholderData)
5. РљРѕРіРґР° СЃРµСЃСЃРёСЏ Р·Р°РіСЂСѓР¶Р°РµС‚СЃСЏ в†’ РґР°РЅРЅС‹Рµ Р°РІС‚РѕРјР°С‚РёС‡РµСЃРєРё Р·Р°РіСЂСѓР¶Р°СЋС‚СЃСЏ

**РЎС†РµРЅР°СЂРёР№: РџРѕР»СЊР·РѕРІР°С‚РµР»СЊ Р·Р°Р»РѕРіРёРЅРёР»СЃСЏ**

1. РЎРµСЃСЃРёСЏ Р·Р°РіСЂСѓР¶РµРЅР° РёР· AsyncStorage
2. вњ… `useRealtimeSync` РїСЂРѕРІРµСЂСЏРµС‚ в†’ РµСЃС‚СЊ СЃРµСЃСЃРёСЏ в†’ СЃРѕР·РґР°РµС‚ РїРѕРґРїРёСЃРєСѓ
3. вњ… `useQueryWithCache` РїСЂРѕРІРµСЂСЏРµС‚ в†’ РµСЃС‚СЊ СЃРµСЃСЃРёСЏ в†’ РґРµР»Р°РµС‚ Р·Р°РїСЂРѕСЃ
4. вњ… Р”Р°РЅРЅС‹Рµ Р·Р°РіСЂСѓР¶Р°СЋС‚СЃСЏ Рё РєСЌС€РёСЂСѓСЋС‚СЃСЏ

## рџ“ќ Р¤Р°Р№Р»С‹ РѕР±РЅРѕРІР»РµРЅС‹

- вњ… `components/hooks/useRealtimeSync.js` - РґРѕР±Р°РІР»РµРЅР° РїСЂРѕРІРµСЂРєР° Р°СѓС‚РµРЅС‚РёС„РёРєР°С†РёРё
- вњ… `components/hooks/useQueryWithCache.js` - РґРѕР±Р°РІР»РµРЅР° РїСЂРѕРІРµСЂРєР° СЃРµСЃСЃРёРё РїРµСЂРµРґ Р·Р°РїСЂРѕСЃРѕРј
- вњ… `components/hooks/useUsers.js` - РїРµСЂРµРґР°С‡Р° supabase РєР»РёРµРЅС‚Р°
- рџ“љ `AUTH_FIX_EXPLANATION.md` - РїРѕРґСЂРѕР±РЅРѕРµ РѕР±СЉСЏСЃРЅРµРЅРёРµ

## рџљЂ Р§С‚Рѕ РјРѕР¶РЅРѕ СѓР»СѓС‡С€РёС‚СЊ РґР°Р»СЊС€Рµ

1. Р”РѕР±Р°РІРёС‚СЊ РѕР±СЂР°Р±РѕС‚РєСѓ СЂР°Р·СЂС‹РІР° СЃРѕРµРґРёРЅРµРЅРёСЏ (Р°РІС‚РѕРјР°С‚РёС‡РµСЃРєРѕРµ РїРµСЂРµРїРѕРґРїРёСЃР°РЅРёРµ)
2. Р”РѕР±Р°РІРёС‚СЊ retry Р»РѕРіРёРєСѓ РґР»СЏ realtime РїРѕРґРїРёСЃРѕРє
3. РџРѕРєР°Р·С‹РІР°С‚СЊ РїРѕР»СЊР·РѕРІР°С‚РµР»СЋ СЃС‚Р°С‚СѓСЃ РїРѕРґРєР»СЋС‡РµРЅРёСЏ Рє realtime
4. Р”РѕР±Р°РІРёС‚СЊ С‚РµСЃС‚С‹ РґР»СЏ РїСЂРѕРІРµСЂРєРё РїРѕРІРµРґРµРЅРёСЏ РїСЂРё СЂР°Р·РЅС‹С… СЃРѕСЃС‚РѕСЏРЅРёСЏС… Р°СѓС‚РµРЅС‚РёС„РёРєР°С†РёРё

---

**РЎС‚Р°С‚СѓСЃ:** вњ… РСЃРїСЂР°РІР»РµРЅРѕ Рё РіРѕС‚РѕРІРѕ Рє РёСЃРїРѕР»СЊР·РѕРІР°РЅРёСЋ
