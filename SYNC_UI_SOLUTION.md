# –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è UI: –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ + Bottom Bar

## –ü—Ä–æ–±–ª–µ–º–∞

Bottom bar –ø–æ—è–≤–ª—è–ª—Å—è —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π ~880–º—Å –ø–æ—Å–ª–µ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏–∑-–∑–∞ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã—Ö —Ç–∞–π–º–µ—Ä–æ–≤ (`MIN_SPLASH_MS=600` + `NET_IDLE_GRACE_MS=280`).

## –†–µ—à–µ–Ω–∏–µ: –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

### 1. –ì–ª–æ–±–∞–ª—å–Ω—ã–π –º–æ–¥—É–ª—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (`lib/appReadyState.js`)

–°–æ–∑–¥–∞–Ω singleton –∫–ª–∞—Å—Å `AppReadyState` –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ UI:

```javascript
class AppReadyState {
  bootState =
    {
      current: 'boot' | 'fetching' | 'ready',
      mountTs: Date.now(),
    } -
    // –ú–µ—Ç–æ–¥—ã:
    getBootState() - // —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    setBootState(state) - // —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ + —É–≤–µ–¥–æ–º–∏—Ç—å –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤
    isReady() - // –ø—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
    reset() - // —Å–±—Ä–æ—Å –ø—Ä–∏ –ª–æ–≥–∞—É—Ç–µ/–ª–æ–≥–∏–Ω–µ
    subscribe(fn); // –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è
}
```

### 2. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É (`app/orders/index.jsx`)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

- –£–±—Ä–∞–Ω –ª–æ–∫–∞–ª—å–Ω—ã–π `globalBootState` ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `appReadyState`
- –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —á–µ—Ä–µ–∑ `appReadyState.setBootState()`
- –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ—Ä–µ–∑ `appReadyState.subscribe()`
- –ü—Ä–∏ —Å–±—Ä–æ—Å–µ —Å–µ—Å—Å–∏–∏: `appReadyState.reset()`

**–õ–æ–≥–∏–∫–∞:**

```javascript
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∫—ç—à–∞
const [bootState, setBootState] = useState(() => {
  const cachedRole = qc.getQueryData(['userRole']);
  const globalState = appReadyState.getBootState();
  if (cachedRole && globalState === 'ready') return 'ready';
  return 'boot';
});

// –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è
useEffect(() => {
  return appReadyState.subscribe((newState) => {
    setBootState(newState);
  });
}, []);

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
useEffect(() => {
  if (!activeFetching) {
    const wait = Math.max(0, MIN_BOOT_MS - elapsed);
    setTimeout(() => {
      appReadyState.setBootState('ready'); // —É–≤–µ–¥–æ–º–∏—Ç –≤—Å–µ—Ö –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤
    }, wait);
  }
}, [activeFetching, bootState]);
```

### 3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ Bottom Bar (`components/navigation/BottomNav.jsx`)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

- –£–±—Ä–∞–Ω—ã —Ç–∞–π–º–µ—Ä—ã `MIN_SPLASH_MS`, `NET_IDLE_GRACE_MS`, `navStartRef`
- –£–±—Ä–∞–Ω–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç `isFetching` (—Ç–µ–ø–µ—Ä—å —Ç–æ–ª—å–∫–æ `roleLoading`, `canAllLoading`)
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ `appReadyState`

**–õ–æ–≥–∏–∫–∞:**

```javascript
// –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –≥–ª–æ–±–∞–ª—å–Ω—ã–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º
const [appReady, setAppReady] = useState(() => appReadyState.isReady());

useEffect(() => {
  return appReadyState.subscribe((state) => {
    setAppReady(state === 'ready');
  });
}, []);

// –ü–æ–∫–∞–∑ –±–∞—Ä–∞ —Å—Ç—Ä–æ–≥–æ –∫–æ–≥–¥–∞ –≥–ª–∞–≤–Ω–∞—è –≥–æ—Ç–æ–≤–∞
useEffect(() => {
  if (navVisible) return;

  const dataReady = !roleLoading && !canAllLoading && !!role;

  if (dataReady && appReady) {
    setTimeout(() => setNavVisible(true), 0);
  }
}, [navVisible, roleLoading, canAllLoading, role, appReady]);
```

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ä–µ—à–µ–Ω–∏—è

### 1. –°–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å

- Bottom bar –ø–æ—è–≤–ª—è–µ—Ç—Å—è **—Å—Ç—Ä–æ–≥–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ** —Å –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ–π
- –ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –¥–ª—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ UI

### 2. –ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å

- –ü–æ–¥–ø–∏—Å—á–∏–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞—é—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏ –ª—é–±—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
- –ù–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –ø–æ—Ä—è–¥–∫–∞ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø–æ–¥–ø–∏—Å–æ–∫ –ø—Ä–∏ unmount

### 3. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- –ú–∏–Ω–∏–º—É–º –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö —Ä–µ–Ω–¥–µ—Ä–æ–≤
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–µ–∂–¥—É –Ω–∞–≤–∏–≥–∞—Ü–∏—è–º–∏
- –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –ø–æ–∫–∞–∑ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –∫—ç—à–∞ (–ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –≤–∏–∑–∏—Ç—ã)

### 4. –£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å

- –ó–∞—â–∏—Ç–∞ –æ—Ç race conditions
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –ø—Ä–∏ –ª–æ–≥–∞—É—Ç–µ/–ª–æ–≥–∏–Ω–µ (—á–µ—Ä–µ–∑ `reset()`)
- Fallback –Ω–∞ `MAX_BOOT_MS` (5 —Å–µ–∫—É–Ω–¥) –ø—Ä–æ—Ç–∏–≤ –∑–∞–≤–∏—Å–∞–Ω–∏–π

### 5. –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å

- –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –ø–æ–¥–ø–∏—Å—á–∏–∫–∏ (–¥—Ä—É–≥–∏–µ UI —ç–ª–µ–º–µ–Ω—Ç—ã)
- –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º
- –ü—Ä–æ—Å—Ç–∞—è –æ—Ç–ª–∞–¥–∫–∞ (–æ–¥–∏–Ω –º–æ–¥—É–ª—å –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç –≤—Å—ë)

## –°—Ü–µ–Ω–∞—Ä–∏–∏ —Ä–∞–±–æ—Ç—ã

### –•–æ–ª–æ–¥–Ω—ã–π –∑–∞–ø—É—Å–∫ (–ø–µ—Ä–≤—ã–π –≤–∏–∑–∏—Ç)

1. –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞: `bootState = 'boot'`
2. –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–æ–ª–∏, –ø–µ—Ä–º–∏—à–µ–Ω–æ–≤
3. –ì–ª–∞–≤–Ω–∞—è ‚Üí `appReadyState.setBootState('ready')`
4. Bottom bar –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è **–æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ**

### –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è (–µ—Å—Ç—å –∫—ç—à)

1. –ì–ª–∞–≤–Ω–∞—è: –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫—ç—à —Ä–æ–ª–∏ + –≥–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
2. –ï—Å–ª–∏ –æ–±–∞ –≥–æ—Ç–æ–≤—ã ‚Üí `bootState = 'ready'` –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
3. Bottom bar —Ç–æ–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `appReadyState.isReady()` ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è **–º–≥–Ω–æ–≤–µ–Ω–Ω–æ**
4. **–ù–µ—Ç –ª–æ–∞–¥–µ—Ä–∞, –Ω–µ—Ç –∑–∞–¥–µ—Ä–∂–µ–∫** üöÄ

### –õ–æ–≥–∞—É—Ç/–õ–æ–≥–∏–Ω

1. `onSessionEpoch()` ‚Üí `appReadyState.reset()`
2. –í—Å–µ –ø–æ–¥–ø–∏—Å—á–∏–∫–∏ –ø–æ–ª—É—á–∞—é—Ç `state = 'boot'`
3. –¶–∏–∫–ª –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –∑–∞–Ω–æ–≤–æ (–∫–∞–∫ —Ö–æ–ª–æ–¥–Ω—ã–π —Å—Ç–∞—Ä—Ç)

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏

### –¢–µ—Å—Ç–æ–≤—ã–µ –∫–µ–π—Å—ã

- ‚úÖ –ü–µ—Ä–≤—ã–π –∑–∞—Ö–æ–¥ –ø–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞ ‚Äî —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ
- ‚úÖ –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –≥–ª–∞–≤–Ω—É—é ‚Äî –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
- ‚úÖ –õ–æ–≥–∞—É—Ç ‚Üí –õ–æ–≥–∏–Ω ‚Üí —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–±—Ä–æ—à–µ–Ω–æ
- ‚úÖ –ú–µ–¥–ª–µ–Ω–Ω–∞—è —Å–µ—Ç—å ‚Üí —Ç–∞–π–º–∞—É—Ç MAX_BOOT_MS —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç
- ‚úÖ –ë—ã—Å—Ç—Ä–∞—è —Å–µ—Ç—å + –∫—ç—à ‚Üí MIN_BOOT_MS –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è

### –û—Ç–ª–∞–¥–∫–∞

```javascript
// –î–æ–±–∞–≤–∏—Ç—å –≤ appReadyState.js –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:
setBootState(state) {
  if (this.bootState.current !== state) {
    console.log(`[AppReadyState] ${this.bootState.current} ‚Üí ${state}`);
    this.bootState.current = state;
    this.notifyListeners();
  }
}
```

## –ß—Ç–æ –º–æ–∂–µ—Ç —Å–ª–æ–º–∞—Ç—å—Å—è (–∏ –∫–∞–∫ –∑–∞—â–∏—â–µ–Ω–æ)

### 1. Race condition –ø—Ä–∏ –±—ã—Å—Ç—Ä—ã—Ö –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è—Ö

**–ó–∞—â–∏—Ç–∞:** –ø–æ–¥–ø–∏—Å–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

### 2. Memory leak –æ—Ç –ø–æ–¥–ø–∏—Å–æ–∫

**–ó–∞—â–∏—Ç–∞:** –≤—Å–µ –ø–æ–¥–ø–∏—Å–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–ø–∏—Å–∫–∏ –≤ `useEffect` cleanup

### 3. –î–µ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≥–ª–∞–≤–Ω–æ–π –∏ –±–∞—Ä–∞

**–ó–∞—â–∏—Ç–∞:** –µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è, –æ–±–∞ —á–∏—Ç–∞—é—Ç –∏–∑ `appReadyState`

### 4. –ë–∞—Ä –Ω–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è —Å–æ–≤—Å–µ–º

**–ó–∞—â–∏—Ç–∞:**

- `MAX_BOOT_MS` —Ñ–æ—Ä—Å–∏—Ä—É–µ—Ç –ø–µ—Ä–µ—Ö–æ–¥ –≤ `ready`
- –õ–æ–∫–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ `dataReady` –≤ –±–∞—Ä–µ

### 5. –ì–ª–∞–≤–Ω–∞—è —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ unmount

**–ó–∞—â–∏—Ç–∞:** —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ **–≥–ª–æ–±–∞–ª—å–Ω–æ–º** singleton, –Ω–µ –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–†–µ—à–µ–Ω–∏–µ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç **–∏–¥–µ–∞–ª—å–Ω—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é** UI —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —á–µ—Ä–µ–∑ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏. –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞–¥—ë–∂–Ω–æ –ø—Ä–∏ –ª—é–±—ã—Ö –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞—Ö: —Ö–æ–ª–æ–¥–Ω—ã–π —Å—Ç–∞—Ä—Ç, –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –≤–∏–∑–∏—Ç—ã, –º–µ–¥–ª–µ–Ω–Ω–∞—è/–±—ã—Å—Ç—Ä–∞—è —Å–µ—Ç—å, –ª–æ–≥–∞—É—Ç/–ª–æ–≥–∏–Ω.
