# Инструкция по исправлению создания пользователей

## Проблема
При создании новых пользователей возникают ошибки:
- "Database error checking email"
- "Database error finding user"

## Причина
Предыдущие попытки создания пользователей через RPC функции с `gen_salt()` и `gen_random_bytes()` создали поврежденные записи в `auth.users`.

## Решение

### Шаг 1: Проверка состояния базы
Выполните в Supabase SQL Editor файл: `check_auth_users.sql`

Это покажет:
- Записи в `auth.users` для проблемных email
- Профили с этими email
- Пользователей без профилей (orphaned users)

### Шаг 2: Очистка поврежденных данных
Если вы увидели orphaned users или проблемные записи, выполните `cleanup_auth_users.sql`

**ВНИМАНИЕ:** Это удалит:
- Пользователей из `auth.users` без соответствующих профилей
- Только за последние 7 дней (для безопасности)

### Шаг 3: Обновление SQL функций
Выполните в Supabase SQL Editor файл: `deploy_functions.sql`

Изменения:
- Функция `invite_user` теперь только создает профиль
- Удалены попытки создания записей в `auth.users` через SQL
- Убраны вызовы `gen_salt()` и `gen_random_bytes()`

### Шаг 4: Перезапуск приложения
```powershell
npx expo start --clear
```

### Шаг 5: Тестирование
1. Откройте приложение на телефоне
2. Попробуйте создать нового пользователя с **новым email** (не использованным ранее)
3. Проверьте:
   - ✅ Пользователь создается без ошибок
   - ✅ Профиль создается в `profiles`
   - ✅ Email с паролем отправляется

## Новый Flow создания пользователя

1. **Проверка email** - приложение проверяет, нет ли уже профиля с таким email
2. **inviteUserByEmail** - Admin API создает пользователя в `auth.users`
3. **updateUserById** - Admin API устанавливает пароль и подтверждает email
4. **RPC invite_user** - создает профиль в таблице `profiles`
5. **Email отправка** - email-сервер на VPS отправляет пароль пользователю

## Преимущества нового подхода
- ✅ Использует встроенные методы Supabase (более надежно)
- ✅ Не требует прямого доступа к `auth.users` через SQL
- ✅ Правильное хеширование паролей
- ✅ Атомарные операции с откатом при ошибках
- ✅ Понятная последовательность действий

## Отладка

Если пользователь не создается:

1. Проверьте логи в приложении (Metro bundler)
2. Проверьте логи Supabase (Dashboard → Logs)
3. Проверьте email-сервер: `ssh root@5.35.91.118 "docker logs --tail 50 email-server"`
4. Убедитесь, что `supabaseServiceKey` правильный в `app.json`

## Email сервис

Email-сервер на VPS:
- Адрес: http://5.35.91.118:3000
- Postfix настроен и принимает relay от Docker (172.17.0.0/16)
- Проверка: `ssh root@5.35.91.118 "curl http://localhost:3000/health"`

## Сброс пароля

Сброс пароля также использует Admin API:
```javascript
await supabaseAdmin.auth.admin.updateUserById(userId, { password: newPassword })
```

Затем отправляется email с новым паролем через email-сервер.
