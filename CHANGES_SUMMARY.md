> **Status (2026-02-11): Legacy reference.** This document contains historical notes about removed hooks (`useQueryWithCache`, `useRealtimeSync`).
> Current data layer uses TanStack Query feature hooks in `src/features/*` with shared keys in `src/shared/query/queryKeys.ts`.
# рџ“‹ РџРѕР»РЅС‹Р№ СЃРїРёСЃРѕРє РёР·РјРµРЅРµРЅРёР№ РґР»СЏ РёСЃРїСЂР°РІР»РµРЅРёСЏ РІР°СЂРЅРёРЅРіРѕРІ Р°РІС‚РѕСЂРёР·Р°С†РёРё

## рџЋЇ Р¦РµР»СЊ

РСЃРїСЂР°РІРёС‚СЊ РІР°СЂРЅРёРЅРіРё:

- `WARN refresh error: Auth session missing!`
- `WARN Initial fetch failed: permission denied for table profiles`

## рџ“ќ РР·РјРµРЅРµРЅРЅС‹Рµ С„Р°Р№Р»С‹

### 1. вњ… `components/hooks/useAuth.js` (РќРћР’Р«Р™)

**РЎС‚Р°С‚СѓСЃ:** РЎРѕР·РґР°РЅ РЅРѕРІС‹Р№ С„Р°Р№Р»  
**РќР°Р·РЅР°С‡РµРЅРёРµ:** Р¦РµРЅС‚СЂР°Р»СЊРЅС‹Р№ С…РѕРє РґР»СЏ РїСЂРѕРІРµСЂРєРё СЃС‚Р°С‚СѓСЃР° Р°СѓС‚РµРЅС‚РёС„РёРєР°С†РёРё  
**Р§С‚Рѕ РґРµР»Р°РµС‚:**

- РџСЂРѕРІРµСЂСЏРµС‚ РЅР°Р»РёС‡РёРµ СЃРµСЃСЃРёРё РїСЂРё РјРѕРЅС‚РёСЂРѕРІР°РЅРёРё
- РџРѕРґРїРёСЃС‹РІР°РµС‚СЃСЏ РЅР° РёР·РјРµРЅРµРЅРёСЏ auth СЃРѕСЃС‚РѕСЏРЅРёСЏ
- Р’РѕР·РІСЂР°С‰Р°РµС‚: `isAuthenticated`, `isLoading`, `user`

**РџРѕС‡РµРјСѓ:**

- РћРґРёРЅ РёСЃС‚РѕС‡РЅРёРє РёСЃС‚РёРЅС‹ РґР»СЏ РІСЃРµС… РїСЂРѕРІРµСЂРѕРє auth
- Р РµР°РєС‚РёРІРЅРѕРµ РѕР±РЅРѕРІР»РµРЅРёРµ РїСЂРё РёР·РјРµРЅРµРЅРёРё СЃРµСЃСЃРёРё
- РР·Р±РµРіР°РµРј РјРЅРѕР¶РµСЃС‚РІРµРЅРЅС‹С… РїСЂРѕРІРµСЂРѕРє auth РІ СЂР°Р·РЅС‹С… РјРµСЃС‚Р°С…

---

### 2. вњ… `components/hooks/useRealtimeSync.js`

**РЎС‚Р°С‚СѓСЃ:** РЈРїСЂРѕС‰РµРЅРѕ  
**РЈРґР°Р»РµРЅРѕ:**

- Р“Р»РѕР±Р°Р»СЊРЅС‹Р№ С„Р»Р°Рі `globalAuthStatus`
- Р¤СѓРЅРєС†РёСЏ `checkAuth()` РІРЅСѓС‚СЂРё С…СѓРєР°
- РЎРѕСЃС‚РѕСЏРЅРёРµ `isAuthChecked`
- РЈСЃР»РѕРІРёРµ РїСЂРѕРІРµСЂРєРё `!globalAuthStatus.isAuthenticated` РІ Р·Р°РІРёСЃРёРјРѕСЃС‚СЏС…

**Р”РѕР±Р°РІР»РµРЅРѕ:**

- РљРѕРјРјРµРЅС‚Р°СЂРёР№ Рѕ РЅРµРѕР±С…РѕРґРёРјРѕСЃС‚Рё РєРѕРЅС‚СЂРѕР»СЏ `enabled` СЃРЅР°СЂСѓР¶Рё

**Р›РѕРіРёРєР°:**

```javascript
// Р‘Р«Р›Рћ (СЃР»РѕР¶РЅРѕ):
if (!enabled || !supabaseClient || !table || !isAuthChecked || !globalAuthStatus.isAuthenticated)
  return;

// РЎРўРђР›Рћ (РїСЂРѕСЃС‚Рѕ):
if (!enabled || !supabaseClient || !table) return;
```

**РџРѕС‡РµРјСѓ:**

- РљРѕРЅС‚СЂРѕР»СЊ auth С‚РµРїРµСЂСЊ РЅР° СѓСЂРѕРІРЅРµ РІС‹Р·С‹РІР°СЋС‰РёС… С…СѓРєРѕРІ
- РњРµРЅСЊС€Рµ РєРѕРґР°, Р±РѕР»РµРµ РїРѕРЅСЏС‚РЅР°СЏ Р»РѕРіРёРєР°
- РР·Р±РµРіР°РµРј race conditions СЃ РіР»РѕР±Р°Р»СЊРЅС‹Рј С„Р»Р°РіРѕРј

---

### 3. вњ… `components/hooks/useQueryWithCache.js`

**РЎС‚Р°С‚СѓСЃ:** РЈРїСЂРѕС‰РµРЅРѕ  
**РЈРґР°Р»РµРЅРѕ:**

- РџР°СЂР°РјРµС‚СЂ `supabase` (Р±РѕР»СЊС€Рµ РЅРµ РЅСѓР¶РµРЅ)
- Р’РµСЃСЊ Р±Р»РѕРє РїСЂРѕРІРµСЂРєРё auth РІ `fetchData`:
  ```javascript
  try {
    if (!isRefresh && !skipCache) {
      const client = supabase || supabaseClient;
      const { data: sessionData } = await client?.auth?.getSession?.();
      if (!sessionData?.session && queryKey.includes('profiles')) {
        // ... СЃР»РѕР¶РЅР°СЏ Р»РѕРіРёРєР° ...
      }
    }
  } catch (err) { ... }
  ```

**РџРѕС‡РµРјСѓ:**

- РљРѕРЅС‚СЂРѕР»СЊ `enabled` РіР°СЂР°РЅС‚РёСЂСѓРµС‚, С‡С‚Рѕ Р·Р°РїСЂРѕСЃ РЅРµ Р±СѓРґРµС‚ СЃРґРµР»Р°РЅ Р±РµР· auth
- РќРµС‚ РЅРµРѕР±С…РѕРґРёРјРѕСЃС‚Рё РІ РґСѓР±Р»РёСЂСѓСЋС‰РµР№ РїСЂРѕРІРµСЂРєРµ РІРЅСѓС‚СЂРё fetchData
- РЈРїСЂРѕС‰Р°РµС‚СЃСЏ Р»РѕРіРёРєР° Рё С‚РµСЃС‚РёСЂРѕРІР°РЅРёРµ

---

### 4. вњ… `components/hooks/useUsers.js`

**РЎС‚Р°С‚СѓСЃ:** РћР±РЅРѕРІР»РµРЅРѕ  
**Р”РѕР±Р°РІР»РµРЅРѕ:**

```javascript
import { useAuth } from './useAuth';

export function useUsers(options = {}) {
  const { filters = {}, enabled = true } = options;
  const { isAuthenticated } = useAuth(); // в†ђ РќРћР’РћР•

  // ... РєРѕРґ ...

  const { data, ... } = useQueryWithCache({
    // ... РїР°СЂР°РјРµС‚СЂС‹ ...
    // supabase, в†ђ РЈР”РђР›Р•РќРћ (Р±РѕР»СЊС€Рµ РЅРµ РїРµСЂРµРґР°РµС‚СЃСЏ)
  });

  useRealtimeSync({
    // ... РїР°СЂР°РјРµС‚СЂС‹ ...
    enabled: enabled && isAuthenticated, // в†ђ РР—РњР•РќР•РќРћ
  });
}
```

**РљР°Рє СЌС‚Рѕ СЂР°Р±РѕС‚Р°РµС‚:**

- `useAuth()` РїСЂРѕРІРµСЂСЏРµС‚ РЅР°Р»РёС‡РёРµ СЃРµСЃСЃРёРё
- `isAuthenticated` СѓРїСЂР°РІР»СЏРµС‚ `enabled` РїР°СЂР°РјРµС‚СЂРѕРј
- Realtime РїРѕРґРїРёСЃРєР° СЃРѕР·РґР°РµС‚СЃСЏ С‚РѕР»СЊРєРѕ РµСЃР»Рё РїРѕР»СЊР·РѕРІР°С‚РµР»СЊ Р°СѓС‚РµРЅС‚РёС„РёС†РёСЂРѕРІР°РЅ

---

### 5. вњ… `components/hooks/useDepartments.js`

**РЎС‚Р°С‚СѓСЃ:** РћР±РЅРѕРІР»РµРЅРѕ (Р°РЅР°Р»РѕРіРёС‡РЅРѕ useUsers)  
**Р”РѕР±Р°РІР»РµРЅРѕ:**

```javascript
import { useAuth } from './useAuth';

export function useDepartments(options = {}) {
  const { companyId, enabled = true, onlyEnabled = true } = options;
  const { isAuthenticated } = useAuth(); // в†ђ РќРћР’РћР•

  // ... РєРѕРґ ...

  useRealtimeSync({
    // ... РїР°СЂР°РјРµС‚СЂС‹ ...
    enabled: enabled && !!companyId && isAuthenticated, // в†ђ РР—РњР•РќР•РќРћ
  });
}
```

---

## рџ”Ќ Р”РµС‚Р°Р»СЊРЅРѕРµ РѕР±СЉСЏСЃРЅРµРЅРёРµ РёСЃРїСЂР°РІР»РµРЅРёСЏ

### Р”Рѕ РёСЃРїСЂР°РІР»РµРЅРёСЏ (РїСЂРѕР±Р»РµРјРЅС‹Р№ РїРѕС‚РѕРє):

```
1. useUsers() РІС‹Р·С‹РІР°РµС‚СЃСЏ
2. useRealtimeSync() РІС‹Р·С‹РІР°РµС‚СЃСЏ Р’РЎР•Р“Р”Рђ (enabled РЅРµ РїСЂРѕРІРµСЂСЏР»СЃСЏ)
3. useRealtimeSync РїС‹С‚Р°РµС‚СЃСЏ РїСЂРѕРІРµСЂРёС‚СЊ auth Р°СЃРёРЅС…СЂРѕРЅРЅРѕ
4. вљ пёЏ Realtime РїС‹С‚Р°РµС‚СЃСЏ РїРѕРґРїРёСЃР°С‚СЊСЃСЏ Р‘Р•Р— Р°СѓС‚РµРЅС‚РёС„РёРєР°С†РёРё
5. вќЊ WARN: Auth session missing!
6. useQueryWithCache РґРµР»Р°РµС‚ Р·Р°РїСЂРѕСЃ Рє profiles Р±РµР· auth
7. вќЊ WARN: permission denied for table profiles
```

### РџРѕСЃР»Рµ РёСЃРїСЂР°РІР»РµРЅРёСЏ (РїСЂР°РІРёР»СЊРЅС‹Р№ РїРѕС‚РѕРє):

```
1. useAuth() РїСЂРѕРІРµСЂСЏРµС‚ РЅР°Р»РёС‡РёРµ СЃРµСЃСЃРёРё Рё РІРѕР·РІСЂР°С‰Р°РµС‚ isAuthenticated
2. useUsers() РїРѕР»СѓС‡Р°РµС‚ isAuthenticated
3. useRealtimeSync({..., enabled: enabled && isAuthenticated})
   - Р•СЃР»Рё isAuthenticated = false в†’ enabled = false в†’ РїРѕРґРїРёСЃРєР° РќР• СЃРѕР·РґР°РµС‚СЃСЏ
   - Р•СЃР»Рё isAuthenticated = true в†’ enabled = true в†’ РїРѕРґРїРёСЃРєР° СЃРѕР·РґР°РµС‚СЃСЏ
4. вњ… РќРµС‚ РІР°СЂРЅРёРЅРіРѕРІ!
5. РљРѕРіРґР° СЃРµСЃСЃРёСЏ Р·Р°РіСЂСѓР¶Р°РµС‚СЃСЏ в†’ isAuthenticated РјРµРЅСЏРµС‚СЃСЏ в†’ РїРѕРґРїРёСЃРєР° СЃРѕР·РґР°РµС‚СЃСЏ Р°РІС‚РѕРјР°С‚РёС‡РµСЃРєРё
6. вњ… Р’СЃРµ СЂР°Р±РѕС‚Р°РµС‚ РіР»Р°РґРєРѕ!
```

---

## рџ“Љ Р’Р»РёСЏРЅРёРµ РёР·РјРµРЅРµРЅРёР№

### РќР° РїСЂРѕРёР·РІРѕРґРёС‚РµР»СЊРЅРѕСЃС‚СЊ:

- вњ… РЈРјРµРЅСЊС€РёР»РѕСЃСЊ РєРѕР»РёС‡РµСЃС‚РІРѕ РїСЂРѕРІРµСЂРѕРє auth (Р±С‹Р»Рѕ 2-3, СЃС‚Р°Р»Рѕ 1)
- вњ… РЈР±СЂР°РЅР° СЃР»РѕР¶РЅР°СЏ Р»РѕРіРёРєР° СЃ РіР»РѕР±Р°Р»СЊРЅС‹РјРё С„Р»Р°РіР°РјРё
- вњ… Race conditions РёСЃРєР»СЋС‡РµРЅС‹

### РќР° С‡РёС‚Р°РµРјРѕСЃС‚СЊ РєРѕРґР°:

- вњ… Р›РѕРіРёРєР° auth РєРѕРЅС‚СЂРѕР»СЏ СЏСЃРЅР° Рё РїРѕРЅСЏС‚РЅР°
- вњ… Р Р°Р·РґРµР»РµРЅРёРµ РѕС‚РІРµС‚СЃС‚РІРµРЅРЅРѕСЃС‚Рё: useAuth РїСЂРѕРІРµСЂСЏРµС‚, useUsers/useDepartments РєРѕРЅС‚СЂРѕР»РёСЂСѓСЋС‚
- вњ… РњРµРЅСЊС€Рµ СѓСЃР»РѕРІРЅС‹С… РїСЂРѕРІРµСЂРѕРє

### РќР° РЅР°РґРµР¶РЅРѕСЃС‚СЊ:

- вњ… Realtime РїРѕРґРїРёСЃРєР° РЅРµ СЃРѕР·РґР°РµС‚СЃСЏ Р±РµР· auth (РЅРµС‚ РѕС€РёР±РѕРє)
- вњ… Р”Р°РЅРЅС‹Рµ Р·Р°РіСЂСѓР¶Р°СЋС‚СЃСЏ РєРѕСЂСЂРµРєС‚РЅРѕ
- вњ… Graceful fallback РЅР° РєСЌС€ РїСЂРё РѕС‚СЃСѓС‚СЃС‚РІРёРё auth

---

## вњ… РџСЂРѕРІРµСЂРєР° РёСЃРїСЂР°РІР»РµРЅРёСЏ

### РўРµСЃС‚РѕРІС‹Рµ СЃС†РµРЅР°СЂРёРё:

**РЎС†РµРЅР°СЂРёР№ 1: РҐРѕР»РѕРґРЅС‹Р№ СЃС‚Р°СЂС‚ РїСЂРёР»РѕР¶РµРЅРёСЏ**

```javascript
// РћР¶РёРґР°РµРјРѕРµ РїРѕРІРµРґРµРЅРёРµ:
// 1. useAuth в†’ isAuthenticated = false
// 2. useRealtimeSync РїРѕР»СѓС‡Р°РµС‚ enabled = false
// 3. РџРѕРґРїРёСЃРєР° РќР• СЃРѕР·РґР°РµС‚СЃСЏ
// 4. РџРѕРєР°Р·С‹РІР°РµРј РїСѓСЃС‚РѕР№ СЃРїРёСЃРѕРє
// вњ… РќРµС‚ РІР°СЂРЅРёРЅРіРѕРІ!
```

**РЎС†РµРЅР°СЂРёР№ 2: РџРѕСЃР»Рµ Р»РѕРіРёРЅР°**

```javascript
// РћР¶РёРґР°РµРјРѕРµ РїРѕРІРµРґРµРЅРёРµ:
// 1. useAuth в†’ isAuthenticated = true
// 2. useRealtimeSync РїРѕР»СѓС‡Р°РµС‚ enabled = true
// 3. РџРѕРґРїРёСЃРєР° СЃРѕР·РґР°РµС‚СЃСЏ СѓСЃРїРµС€РЅРѕ
// 4. Р”Р°РЅРЅС‹Рµ Р·Р°РіСЂСѓР¶Р°СЋС‚СЃСЏ Рё РѕС‚РѕР±СЂР°Р¶Р°СЋС‚СЃСЏ
// вњ… Р’СЃРµ СЂР°Р±РѕС‚Р°РµС‚!
```

**РЎС†РµРЅР°СЂРёР№ 3: Р’С‹С…РѕРґ РёР· Р°РєРєР°СѓРЅС‚Р°**

```javascript
// РћР¶РёРґР°РµРјРѕРµ РїРѕРІРµРґРµРЅРёРµ:
// 1. useAuth в†’ isAuthenticated = false
// 2. Realtime РїРѕРґРїРёСЃРєР° РѕС‚РєР»СЋС‡Р°РµС‚СЃСЏ
// 3. РџРѕРєР°Р·С‹РІР°РµРј РєСЌС€РёСЂРѕРІР°РЅРЅС‹Рµ РґР°РЅРЅС‹Рµ
// вњ… Graceful degradation!
```

---

## рџЋ‰ Р РµР·СѓР»СЊС‚Р°С‚

| РџСЂРѕР±Р»РµРјР°                               | Р‘С‹Р»Рѕ              | РЎС‚Р°Р»Рѕ                |
| -------------------------------------- | ----------------- | -------------------- |
| `Auth session missing!`                | вќЊ WARN РІ РєРѕРЅСЃРѕР»Рё | вњ… РСЃРїСЂР°РІР»РµРЅРѕ        |
| `permission denied for table profiles` | вќЊ WARN РІ РєРѕРЅСЃРѕР»Рё | вњ… РСЃРїСЂР°РІР»РµРЅРѕ        |
| Realtime РІ РѕС„С„Р»Р°Р№РЅРµ                    | вќЊ РћС€РёР±РєР°         | вњ… Graceful fallback |
| РљРѕРґ СЃР»РѕР¶РЅРѕСЃС‚СЊ                          | вќЊ Р’С‹СЃРѕРєР°СЏ        | вњ… РќРёР·РєР°СЏ            |
| РџРѕРЅСЏС‚РЅРѕСЃС‚СЊ Р»РѕРіРёРєРё                      | вќЊ РЎР»РѕР¶РЅР°СЏ        | вњ… РЇСЃРЅР°СЏ             |

---

## рџ“љ Р”РѕРїРѕР»РЅРёС‚РµР»СЊРЅС‹Рµ РјР°С‚РµСЂРёР°Р»С‹

- `AUTH_WARNINGS_FINAL_FIX.md` - РџРѕРґСЂРѕР±РЅРѕРµ РѕР±СЉСЏСЃРЅРµРЅРёРµ СЂРµС€РµРЅРёСЏ
- `AUTH_WARNING_FIX.md` - РљСЂР°С‚РєРѕРµ СЂРµР·СЋРјРµ (СЃС‚Р°СЂР°СЏ РІРµСЂСЃРёСЏ)
- `AUTH_FIX_EXPLANATION.md` - Р”РµС‚Р°Р»СЊРЅС‹Р№ СЂР°Р·Р±РѕСЂ (СЃС‚Р°СЂР°СЏ РІРµСЂСЃРёСЏ)

---

**РЎС‚Р°С‚СѓСЃ:** вњ… **РСЃРїСЂР°РІР»РµРЅРѕ Рё РіРѕС‚РѕРІРѕ Рє РёСЃРїРѕР»СЊР·РѕРІР°РЅРёСЋ!**

Р’Р°СЂРЅРёРЅРіРё РїРѕР»РЅРѕСЃС‚СЊСЋ СѓСЃС‚СЂР°РЅРµРЅС‹ РїСѓС‚РµРј:

1. РЎРѕР·РґР°РЅРёСЏ РЅР°РґРµР¶РЅРѕРіРѕ С…СѓРєР° `useAuth` РґР»СЏ РїСЂРѕРІРµСЂРєРё Р°СѓС‚РµРЅС‚РёС„РёРєР°С†РёРё
2. РџРµСЂРµРґР°С‡Рё РёРЅС„РѕСЂРјР°С†РёРё РѕР± auth СЃРѕСЃС‚РѕСЏРЅРёРё РІ `useRealtimeSync` С‡РµСЂРµР· РїР°СЂР°РјРµС‚СЂ `enabled`
3. РЈРїСЂРѕС‰РµРЅРёСЏ Р»РѕРіРёРєРё РІ `useQueryWithCache` Рё `useRealtimeSync`
