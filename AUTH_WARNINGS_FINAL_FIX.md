# ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∞—Ä–Ω–∏–Ω–≥–æ–≤ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ - –§–∏–Ω–∞–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ

## üìã –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤—ã–≤–æ–¥–∏–ª–æ –≤–∞—Ä–Ω–∏–Ω–≥–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ:

```
WARN  refresh error: Auth session missing!
WARN  Initial fetch failed: permission denied for table profiles
```

## üéØ –ü–µ—Ä–≤–æ–ø—Ä–∏—á–∏–Ω—ã

1. **Realtime –ø–æ–¥–ø–∏—Å–∫–∞ –±–µ–∑ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏** - `useRealtimeSync` –≤—ã–∑—ã–≤–∞–ª—Å—è –î–û –ø—Ä–æ–≤–µ—Ä–∫–∏ auth
2. **–ó–∞–ø—Ä–æ—Å –∫ –∑–∞—â–∏—â–µ–Ω–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ –±–µ–∑ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏** - `queryFn` –ø—ã—Ç–∞–ª—Å—è –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–æ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ—Å—Å–∏–∏

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### 1. –ù–æ–≤—ã–π —Ö—É–∫ `useAuth` (components/hooks/useAuth.js)

```javascript
export function useAuth() {
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [isLoading, setIsLoading] = useState(true);
  const [user, setUser] = useState(null);

  useEffect(() => {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ—Å—Å–∏—é –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
    const checkAuth = async () => {
      const { data } = await supabase.auth.getSession();
      setIsAuthenticated(!!data?.session);
    };

    checkAuth();

    // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è auth
    const {
      data: { subscription },
    } = supabase.auth.onAuthStateChange((_event, session) => {
      setIsAuthenticated(!!session);
    });

    return () => subscription?.unsubscribe();
  }, []);

  return { isAuthenticated, isLoading, user };
}
```

**–ß—Ç–æ –¥–∞–µ—Ç:**

- ‚úÖ –ù–∞–¥–µ–∂–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Å–µ—Å—Å–∏–∏
- ‚úÖ –†–µ–∞–∫—Ç–∏–≤–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ auth —Å–æ—Å—Ç–æ—è–Ω–∏—è
- ‚úÖ –û–¥–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

### 2. –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π `useUsers.js`

```javascript
export function useUsers(options = {}) {
  const { filters = {}, enabled = true } = options;
  const { isAuthenticated } = useAuth(); // ‚Üê –ù–æ–≤–æ–µ!

  // ... –∫–æ–¥ –∑–∞–≥—Ä—É–∑–∫–∏ ...

  // Realtime –ø–æ–¥–ø–∏—Å–∫–∞ –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω
  useRealtimeSync({
    supabaseClient: supabase,
    table: 'profiles',
    queryKey,
    onUpdate: refresh,
    enabled: enabled && isAuthenticated, // ‚Üê –ö–ª—é—á–µ–≤–æ–µ —É—Å–ª–æ–≤–∏–µ!
  });

  return { users: data || [], ... };
}
```

**–ß—Ç–æ –¥–∞–µ—Ç:**

- ‚úÖ `useRealtimeSync` –ø–æ–ª—É—á–∞–µ—Ç `enabled=false` –µ—Å–ª–∏ –Ω–µ—Ç auth
- ‚úÖ Realtime –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- ‚úÖ –ü—Ä–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏ —Å–µ—Å—Å–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å–∫–∞

### 3. –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π `useDepartments.js`

–¢–æ –∂–µ —Å–∞–º–æ–µ - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `isAuthenticated` –ø–µ—Ä–µ–¥ `useRealtimeSync`:

```javascript
enabled: enabled && !!companyId && isAuthenticated;
```

### 4. –£–ø—Ä–æ—â–µ–Ω–Ω—ã–π `useRealtimeSync.js`

–£–±—Ä–∞–Ω–∞ —Å–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ auth. –¢–µ–ø–µ—Ä—å –ø—Ä–æ—Å—Ç–æ:

```javascript
useEffect(() => {
  // –ï—Å–ª–∏ enabled=false (–∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç—Å—è —Å–Ω–∞—Ä—É–∂–∏), –Ω–µ –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è
  if (!enabled || !supabaseClient || !table) {
    return;
  }

  // ... —Å–æ–∑–¥–∞–µ–º –ø–æ–¥–ø–∏—Å–∫—É ...
}, [enabled, supabaseClient, table, queryKey, channelName, events]);
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**

- ‚úÖ –ú–µ–Ω—å—à–µ –∫–æ–¥–∞
- ‚úÖ –ü–æ–Ω—è—Ç–Ω–µ–µ –ª–æ–≥–∏–∫–∞
- ‚úÖ –ù–µ—Ç —Å–ª–æ–∂–Ω—ã—Ö –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö —Ñ–ª–∞–≥–æ–≤
- ‚úÖ –ö–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞ —É—Ä–æ–≤–Ω–µ –≤—ã–∑—ã–≤–∞—é—â–∏—Ö —Ö—É–∫–æ–≤

### 5. –£–ø—Ä–æ—â–µ–Ω–Ω—ã–π `useQueryWithCache.js`

–£–¥–∞–ª–µ–Ω–∞ –∏–∑–±—ã—Ç–æ—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ auth:

- –†–∞–Ω—å—à–µ: –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ `fetchData` + –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ `useRealtimeSync` = –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ
- –¢–µ–ø–µ—Ä—å: —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ `enabled` –ø–∞—Ä–∞–º–µ—Ç—Ä

## üîÑ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—Å—Ç–∏–ª–æ—Å—å

```
1. useAuth –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–µ—Å—Å–∏—é ‚Üí isAuthenticated = false
2. useUsers/useDepartments –ø–æ–ª—É—á–∞—é—Ç isAuthenticated = false
3. useRealtimeSync –ø–æ–ª—É—á–∞–µ—Ç enabled = false
4. useQueryWithCache –∑–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ (–≤—ã–∑–æ–≤–∞ fetch –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç, —Ç.–∫. enabled=false –Ω–µ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ queryFn)
5. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ (placeholderData)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –ù–µ—Ç –≤–∞—Ä–Ω–∏–Ω–≥–æ–≤!

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ª–æ–≥–∏–Ω–∏–ª—Å—è

```
1. useAuth –æ–±–Ω–æ–≤–ª—è–µ—Ç isAuthenticated ‚Üí true
2. useUsers/useDepartments –ø–µ—Ä–µ–ø–æ–¥–ø–∏—Å—ã–≤–∞—é—Ç—Å—è —Å isAuthenticated = true
3. useRealtimeSync –ø–æ–ª—É—á–∞–µ—Ç enabled = true ‚Üí —Å–æ–∑–¥–∞–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É
4. useQueryWithCache –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ
5. –î–∞–Ω–Ω—ã–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –í—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞

```
1. onAuthStateChange —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç ‚Üí isAuthenticated = false
2. Realtime –ø–æ–¥–ø–∏—Å–∫–∞ –ø–µ—Ä–µ—Å—Ç–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å (enabled=false)
3. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–µ—Å–ª–∏ –µ—Å—Ç—å)
4. –ù–µ—Ç –æ—à–∏–±–æ–∫!
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ Graceful fallback!

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

| –ü–æ–∫–∞–∑–∞—Ç–µ–ª—å                      | –î–æ         | –ü–æ—Å–ª–µ               |
| ------------------------------- | ---------- | ------------------- |
| –í–∞—Ä–Ω–∏–Ω–≥ "Auth session missing!" | ‚ùå –ï—Å—Ç—å    | ‚úÖ –ù–µ—Ç              |
| –û—à–∏–±–∫–∞ "permission denied"      | ‚ùå –ï—Å—Ç—å    | ‚úÖ –ù–µ—Ç              |
| Realtime –≤ –æ—Ñ—Ñ–ª–∞–π–Ω–µ             | ‚ùå –û—à–∏–±–∫–∞  | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç —Å –∫—ç—à–µ–º |
| –ö–æ–¥ —Å–ª–æ–∂–Ω–æ—Å—Ç—å                   | ‚ùå –í—ã—Å–æ–∫–∞—è | ‚úÖ –ü—Ä–æ—Å—Ç–æ–π          |
| –ü–æ–Ω—è—Ç–Ω–æ—Å—Ç—å –ª–æ–≥–∏–∫–∏               | ‚ùå –°–ª–æ–∂–Ω–∞—è | ‚úÖ –Ø—Å–Ω–∞—è            |

## üìù –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

1. ‚úÖ `components/hooks/useAuth.js` - **–Ω–æ–≤—ã–π** —Ö—É–∫ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ auth
2. ‚úÖ `components/hooks/useRealtimeSync.js` - —É–ø—Ä–æ—â–µ–Ω–æ, —É–±—Ä–∞–Ω–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –ø—Ä–æ–≤–µ—Ä–∫–∞ auth
3. ‚úÖ `components/hooks/useQueryWithCache.js` - —É–ø—Ä–æ—â–µ–Ω–æ, —É–±—Ä–∞–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ auth
4. ‚úÖ `components/hooks/useUsers.js` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ isAuthenticated –ø–µ—Ä–µ–¥ realtime
5. ‚úÖ `components/hooks/useDepartments.js` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ isAuthenticated –ø–µ—Ä–µ–¥ realtime

## üöÄ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:** –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ realtime –≤ UI
2. **–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑—Ä—ã–≤–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:** –î–æ–±–∞–≤–∏—Ç—å retry –ª–æ–≥–∏–∫—É –¥–ª—è realtime –ø–æ–¥–ø–∏—Å–æ–∫
3. **–¢–µ—Å—Ç—ã:** –ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–≤–µ–¥–µ–Ω–∏—è –ø—Ä–∏ —Ä–∞–∑–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏—è—Ö auth

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ü–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∏ –≥–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!**
