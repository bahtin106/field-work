> **Status (2026-02-11): Legacy reference.** This document contains historical notes about removed hooks (`useQueryWithCache`, `useRealtimeSync`).
> Current data layer uses TanStack Query feature hooks in `src/features/*` with shared keys in `src/shared/query/queryKeys.ts`.
# вњ… РСЃРїСЂР°РІР»РµРЅРёРµ РІР°СЂРЅРёРЅРіРѕРІ Р°РІС‚РѕСЂРёР·Р°С†РёРё - Р¤РёРЅР°Р»СЊРЅРѕРµ СЂРµС€РµРЅРёРµ

## рџ“‹ РџСЂРѕР±Р»РµРјР°

РџСЂРёР»РѕР¶РµРЅРёРµ РІС‹РІРѕРґРёР»Рѕ РІР°СЂРЅРёРЅРіРё РїСЂРё Р·Р°РіСЂСѓР·РєРµ:

```
WARN  refresh error: Auth session missing!
WARN  Initial fetch failed: permission denied for table profiles
```

## рџЋЇ РџРµСЂРІРѕРїСЂРёС‡РёРЅС‹

1. **Realtime РїРѕРґРїРёСЃРєР° Р±РµР· Р°СѓС‚РµРЅС‚РёС„РёРєР°С†РёРё** - `useRealtimeSync` РІС‹Р·С‹РІР°Р»СЃСЏ Р”Рћ РїСЂРѕРІРµСЂРєРё auth
2. **Р—Р°РїСЂРѕСЃ Рє Р·Р°С‰РёС‰РµРЅРЅРѕР№ С‚Р°Р±Р»РёС†Рµ Р±РµР· Р°СѓС‚РµРЅС‚РёС„РёРєР°С†РёРё** - `queryFn` РїС‹С‚Р°Р»СЃСЏ РїРѕР»СѓС‡РёС‚СЊ РґР°РЅРЅС‹Рµ РґРѕ Р·Р°РіСЂСѓР·РєРё СЃРµСЃСЃРёРё

## вњ… Р РµС€РµРЅРёРµ

### 1. РќРѕРІС‹Р№ С…СѓРє `useAuth` (components/hooks/useAuth.js)

```javascript
export function useAuth() {
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [isLoading, setIsLoading] = useState(true);
  const [user, setUser] = useState(null);

  useEffect(() => {
    // РџСЂРѕРІРµСЂСЏРµРј СЃРµСЃСЃРёСЋ РїСЂРё РјРѕРЅС‚РёСЂРѕРІР°РЅРёРё
    const checkAuth = async () => {
      const { data } = await supabase.auth.getSession();
      setIsAuthenticated(!!data?.session);
    };

    checkAuth();

    // РџРѕРґРїРёСЃС‹РІР°РµРјСЃСЏ РЅР° РёР·РјРµРЅРµРЅРёСЏ auth
    const {
      data: { subscription },
    } = supabase.auth.onAuthStateChange((_event, session) => {
      setIsAuthenticated(!!session);
    });

    return () => subscription?.unsubscribe();
  }, []);

  return { isAuthenticated, isLoading, user };
}
```

**Р§С‚Рѕ РґР°РµС‚:**

- вњ… РќР°РґРµР¶РЅР°СЏ РїСЂРѕРІРµСЂРєР° РЅР°Р»РёС‡РёСЏ СЃРµСЃСЃРёРё
- вњ… Р РµР°РєС‚РёРІРЅРѕРµ РѕР±РЅРѕРІР»РµРЅРёРµ РїСЂРё РёР·РјРµРЅРµРЅРёРё auth СЃРѕСЃС‚РѕСЏРЅРёСЏ
- вњ… РћРґРЅР° РїСЂРѕРІРµСЂРєР° РґР»СЏ РІСЃРµС… РєРѕРјРїРѕРЅРµРЅС‚РѕРІ

### 2. РћР±РЅРѕРІР»РµРЅРЅС‹Р№ `useUsers.js`

```javascript
export function useUsers(options = {}) {
  const { filters = {}, enabled = true } = options;
  const { isAuthenticated } = useAuth(); // в†ђ РќРѕРІРѕРµ!

  // ... РєРѕРґ Р·Р°РіСЂСѓР·РєРё ...

  // Realtime РїРѕРґРїРёСЃРєР° РўРћР›Р¬РљРћ РµСЃР»Рё Р°СѓС‚РµРЅС‚РёС„РёС†РёСЂРѕРІР°РЅ
  useRealtimeSync({
    supabaseClient: supabase,
    table: 'profiles',
    queryKey,
    onUpdate: refresh,
    enabled: enabled && isAuthenticated, // в†ђ РљР»СЋС‡РµРІРѕРµ СѓСЃР»РѕРІРёРµ!
  });

  return { users: data || [], ... };
}
```

**Р§С‚Рѕ РґР°РµС‚:**

- вњ… `useRealtimeSync` РїРѕР»СѓС‡Р°РµС‚ `enabled=false` РµСЃР»Рё РЅРµС‚ auth
- вњ… Realtime РїРѕРґРїРёСЃРєР° РЅРµ СЃРѕР·РґР°РµС‚СЃСЏ РїСЂРё РѕС‚СЃСѓС‚СЃС‚РІРёРё Р°СѓС‚РµРЅС‚РёС„РёРєР°С†РёРё
- вњ… РџСЂРё РїРѕСЏРІР»РµРЅРёРё СЃРµСЃСЃРёРё Р°РІС‚РѕРјР°С‚РёС‡РµСЃРєРё СЃРѕР·РґР°РµС‚СЃСЏ РїРѕРґРїРёСЃРєР°

### 3. РћР±РЅРѕРІР»РµРЅРЅС‹Р№ `useDepartments.js`

РўРѕ Р¶Рµ СЃР°РјРѕРµ - РґРѕР±Р°РІР»РµРЅР° РїСЂРѕРІРµСЂРєР° `isAuthenticated` РїРµСЂРµРґ `useRealtimeSync`:

```javascript
enabled: enabled && !!companyId && isAuthenticated;
```

### 4. РЈРїСЂРѕС‰РµРЅРЅС‹Р№ `useRealtimeSync.js`

РЈР±СЂР°РЅР° СЃР»РѕР¶РЅР°СЏ Р»РѕРіРёРєР° РїСЂРѕРІРµСЂРєРё auth. РўРµРїРµСЂСЊ РїСЂРѕСЃС‚Рѕ:

```javascript
useEffect(() => {
  // Р•СЃР»Рё enabled=false (РєРѕРЅС‚СЂРѕР»РёСЂСѓРµС‚СЃСЏ СЃРЅР°СЂСѓР¶Рё), РЅРµ РїРѕРґРїРёСЃС‹РІР°РµРјСЃСЏ
  if (!enabled || !supabaseClient || !table) {
    return;
  }

  // ... СЃРѕР·РґР°РµРј РїРѕРґРїРёСЃРєСѓ ...
}, [enabled, supabaseClient, table, queryKey, channelName, events]);
```

**РџСЂРµРёРјСѓС‰РµСЃС‚РІР°:**

- вњ… РњРµРЅСЊС€Рµ РєРѕРґР°
- вњ… РџРѕРЅСЏС‚РЅРµРµ Р»РѕРіРёРєР°
- вњ… РќРµС‚ СЃР»РѕР¶РЅС‹С… РіР»РѕР±Р°Р»СЊРЅС‹С… С„Р»Р°РіРѕРІ
- вњ… РљРѕРЅС‚СЂРѕР»СЊ РЅР° СѓСЂРѕРІРЅРµ РІС‹Р·С‹РІР°СЋС‰РёС… С…СѓРєРѕРІ

### 5. РЈРїСЂРѕС‰РµРЅРЅС‹Р№ `useQueryWithCache.js`

РЈРґР°Р»РµРЅР° РёР·Р±С‹С‚РѕС‡РЅР°СЏ РїСЂРѕРІРµСЂРєР° auth:

- Р Р°РЅСЊС€Рµ: РїСЂРѕРІРµСЂРєР° РІ `fetchData` + РїСЂРѕРІРµСЂРєР° РІ `useRealtimeSync` = РґСѓР±Р»РёСЂРѕРІР°РЅРёРµ
- РўРµРїРµСЂСЊ: С‚РѕР»СЊРєРѕ РѕРґРЅР° РїСЂРѕРІРµСЂРєР° С‡РµСЂРµР· `enabled` РїР°СЂР°РјРµС‚СЂ

## рџ”„ РљР°Рє СЌС‚Рѕ СЂР°Р±РѕС‚Р°РµС‚

### РЎС†РµРЅР°СЂРёР№ 1: РџСЂРёР»РѕР¶РµРЅРёРµ Р·Р°РїСѓСЃС‚РёР»РѕСЃСЊ

```
1. useAuth РїСЂРѕРІРµСЂСЏРµС‚ СЃРµСЃСЃРёСЋ в†’ isAuthenticated = false
2. useUsers/useDepartments РїРѕР»СѓС‡Р°СЋС‚ isAuthenticated = false
3. useRealtimeSync РїРѕР»СѓС‡Р°РµС‚ enabled = false
4. useQueryWithCache Р·Р°РіСЂСѓР¶Р°РµС‚ РґР°РЅРЅС‹Рµ (РІС‹Р·РѕРІР° fetch РЅРµ РїСЂРѕРёСЃС…РѕРґРёС‚, С‚.Рє. enabled=false РЅРµ РїРµСЂРµРґР°РµС‚СЃСЏ РІ queryFn)
5. РџРѕРєР°Р·С‹РІР°РµРј РїСѓСЃС‚РѕР№ СЃРїРёСЃРѕРє (placeholderData)
```

**Р РµР·СѓР»СЊС‚Р°С‚:** вњ… РќРµС‚ РІР°СЂРЅРёРЅРіРѕРІ!

### РЎС†РµРЅР°СЂРёР№ 2: РџРѕР»СЊР·РѕРІР°С‚РµР»СЊ Р·Р°Р»РѕРіРёРЅРёР»СЃСЏ

```
1. useAuth РѕР±РЅРѕРІР»СЏРµС‚ isAuthenticated в†’ true
2. useUsers/useDepartments РїРµСЂРµРїРѕРґРїРёСЃС‹РІР°СЋС‚СЃСЏ СЃ isAuthenticated = true
3. useRealtimeSync РїРѕР»СѓС‡Р°РµС‚ enabled = true в†’ СЃРѕР·РґР°РµС‚ РїРѕРґРїРёСЃРєСѓ
4. useQueryWithCache Р·Р°РіСЂСѓР¶Р°РµС‚ СЃРІРµР¶РёРµ РґР°РЅРЅС‹Рµ
5. Р”Р°РЅРЅС‹Рµ РѕС‚РѕР±СЂР°Р¶Р°СЋС‚СЃСЏ
```

**Р РµР·СѓР»СЊС‚Р°С‚:** вњ… Р’СЃРµ СЂР°Р±РѕС‚Р°РµС‚!

### РЎС†РµРЅР°СЂРёР№ 3: РЎРµСЃСЃРёСЏ РёСЃС‚РµРєР»Р°

```
1. onAuthStateChange СЃСЂР°Р±Р°С‚С‹РІР°РµС‚ в†’ isAuthenticated = false
2. Realtime РїРѕРґРїРёСЃРєР° РїРµСЂРµСЃС‚Р°РµС‚ СЂР°Р±РѕС‚Р°С‚СЊ (enabled=false)
3. РџРѕРєР°Р·С‹РІР°РµРј РєСЌС€РёСЂРѕРІР°РЅРЅС‹Рµ РґР°РЅРЅС‹Рµ (РµСЃР»Рё РµСЃС‚СЊ)
4. РќРµС‚ РѕС€РёР±РѕРє!
```

**Р РµР·СѓР»СЊС‚Р°С‚:** вњ… Graceful fallback!

## рџ“Љ Р РµР·СѓР»СЊС‚Р°С‚С‹

| РџРѕРєР°Р·Р°С‚РµР»СЊ                      | Р”Рѕ         | РџРѕСЃР»Рµ               |
| ------------------------------- | ---------- | ------------------- |
| Р’Р°СЂРЅРёРЅРі "Auth session missing!" | вќЊ Р•СЃС‚СЊ    | вњ… РќРµС‚              |
| РћС€РёР±РєР° "permission denied"      | вќЊ Р•СЃС‚СЊ    | вњ… РќРµС‚              |
| Realtime РІ РѕС„С„Р»Р°Р№РЅРµ             | вќЊ РћС€РёР±РєР°  | вњ… Р Р°Р±РѕС‚Р°РµС‚ СЃ РєСЌС€РµРј |
| РљРѕРґ СЃР»РѕР¶РЅРѕСЃС‚СЊ                   | вќЊ Р’С‹СЃРѕРєР°СЏ | вњ… РџСЂРѕСЃС‚РѕР№          |
| РџРѕРЅСЏС‚РЅРѕСЃС‚СЊ Р»РѕРіРёРєРё               | вќЊ РЎР»РѕР¶РЅР°СЏ | вњ… РЇСЃРЅР°СЏ            |

## рџ“ќ РћР±РЅРѕРІР»РµРЅРЅС‹Рµ С„Р°Р№Р»С‹

1. вњ… `components/hooks/useAuth.js` - **РЅРѕРІС‹Р№** С…СѓРє РґР»СЏ РїСЂРѕРІРµСЂРєРё auth
2. вњ… `components/hooks/useRealtimeSync.js` - СѓРїСЂРѕС‰РµРЅРѕ, СѓР±СЂР°РЅР° РІРЅСѓС‚СЂРµРЅРЅСЏСЏ РїСЂРѕРІРµСЂРєР° auth
3. вњ… `components/hooks/useQueryWithCache.js` - СѓРїСЂРѕС‰РµРЅРѕ, СѓР±СЂР°РЅР° РїСЂРѕРІРµСЂРєР° auth
4. вњ… `components/hooks/useUsers.js` - РґРѕР±Р°РІР»РµРЅР° РїСЂРѕРІРµСЂРєР° isAuthenticated РїРµСЂРµРґ realtime
5. вњ… `components/hooks/useDepartments.js` - РґРѕР±Р°РІР»РµРЅР° РїСЂРѕРІРµСЂРєР° isAuthenticated РїРµСЂРµРґ realtime

## рџљЂ Р”РѕРїРѕР»РЅРёС‚РµР»СЊРЅС‹Рµ СЂРµРєРѕРјРµРЅРґР°С†РёРё

1. **РџРѕРєР°Р·Р°С‚СЊ СЃС‚Р°С‚СѓСЃ РїРѕРґРєР»СЋС‡РµРЅРёСЏ:** Р”РѕР±Р°РІРёС‚СЊ РёРЅРґРёРєР°С‚РѕСЂ РїРѕРґРєР»СЋС‡РµРЅРёСЏ Рє realtime РІ UI
2. **РћР±СЂР°Р±РѕС‚РєР° СЂР°Р·СЂС‹РІР° СЃРѕРµРґРёРЅРµРЅРёСЏ:** Р”РѕР±Р°РІРёС‚СЊ retry Р»РѕРіРёРєСѓ РґР»СЏ realtime РїРѕРґРїРёСЃРѕРє
3. **РўРµСЃС‚С‹:** РќР°РїРёСЃР°С‚СЊ С‚РµСЃС‚С‹ РґР»СЏ РїСЂРѕРІРµСЂРєРё РїРѕРІРµРґРµРЅРёСЏ РїСЂРё СЂР°Р·РЅС‹С… СЃРѕСЃС‚РѕСЏРЅРёСЏС… auth

---

**РЎС‚Р°С‚СѓСЃ:** вњ… **РџРѕР»РЅРѕСЃС‚СЊСЋ РёСЃРїСЂР°РІР»РµРЅРѕ Рё РіРѕС‚РѕРІРѕ Рє РёСЃРїРѕР»СЊР·РѕРІР°РЅРёСЋ!**
